<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InfraFlow - Sistema de Monitoramento</title>
  <link rel="stylesheet" href="../css/dashboards.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="../assets/imgs/estrada.png">
</head>

<body>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <aside class="sidebar">

      <nav class="nav">
        <button data-view="overview" class="nav-item active">
          <i class="fas fa-gauge"></i>
          <span>Painel</span>
        </button>
        <button data-view="monitor" class="nav-item">
          <i class="fas fa-chart-line"></i>
          <span>Monitoramento</span>
        </button>
        <button data-view="cadastro" class="nav-item">
          <i class="fas fa-pen-to-square"></i>
          <span>Cadastro</span>
        </button>
        <a href="dashboard-alertas.html" class="nav-item" style="text-decoration: none;">
          <i class="fas fa-clock-rotate-left"></i>
          <span>Histórico de Alertas</span>
        </a>
      </nav>

      <div class="divider"></div>

      <!-- <div class="filters">
        <div class="filters-title">
          <i class="fas fa-filter"></i>
          <span>Componentes</span>
        </div>
        <label class="filter-item">
          <input type="checkbox" class="flt-comp" value="cpu" checked>
          <span class="checkmark"></span>
          <i class="fas fa-microchip"></i>
          <span>CPU</span>
        </label>
        <label class="filter-item">
          <input type="checkbox" class="flt-comp" value="memoria" checked>
          <span class="checkmark"></span>
          <i class="fas fa-memory"></i>
          <span>Memória</span>
        </label>
        <label class="filter-item">
          <input type="checkbox" class="flt-comp" value="disco" checked>
          <span class="checkmark"></span>
          <i class="fas fa-hdd"></i>
          <span>Disco</span>
        </label>
        <label class="filter-item">
          <input type="checkbox" class="flt-comp" value="rede" checked>
          <span class="checkmark"></span>
          <i class="fas fa-network-wired"></i>
          <span>Rede</span>
        </label>
      </div> -->

      <div class="user-section">
        <div class="user-info">
          <i class="fas fa-user-circle"></i>
          <span id="sidebarUser">Admin</span>
        </div>
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <!-- Topbar -->
      <header class="topbar">

        <div class="brand">
          <a href="dashboard.html" title="Voltar para o painel principal">
            <img src="../assets/infra-parafundobranco.png" alt="InfraFlow">
          </a>
        </div>
        <div class="topbar-left">
          <div class="machine-select">
            <i class="fas fa-server"></i>
            <label for="edgeSelector" style="display:block; font-size:14px; margin-bottom:4px; color: gray;">
              Selecione um pórtico FreeFlow:
            </label>
            <select id="edgeSelector">
              <option value="INFRA-EDGE-01-Itápolis (SP-333)">INFRA-EDGE-01-Itápolis (SP-333)</option>
              <!-- <option value="INFRA-EDGE-02-Jaboticabal (SP-333)">INFRA-EDGE-02-Jaboticabal (SP-333)</option>
              <option value="INFRA-EDGE-03-São José dos Campos (SP-099)">INFRA-EDGE-03-São José dos Campos (SP-099)
              </option>
              <option value="INFRA-EDGE-04-Itaguaí (Km 414)">INFRA-EDGE-04-Itaguaí (Km 414)</option> -->
            </select>
          </div>
          <div class="os-info">
            <i class="fab fa-ubuntu"></i>
            <span>Ubuntu 22.04 LTS</span>
          </div>
        </div>

        <div class="topbar-right">
          <div class="security-indicator">
            <a href="seguranca.html" class="nocsec-link" title="NOC/SOC - Centro de Segurança">
              <i class="fas fa-shield-alt"></i>
              <span>NOC/SOC</span>
            </a>
          </div>
          <div class="status-indicator">
            <div class="status-dot"></div>
            <span>Online</span>
          </div>
          <div class="last-update">
            <span class="update-label">Última atualização:</span>
            <span class="update-time" id="lastUpdateTime">--:--:--</span>
          </div>
        </div>



      </header>

      <!-- Visão Geral -->
      <section id="view-overview" class="view active">
        <div class="view-header">
          <h1 class="view-title">
            <i class="fas fa-gauge"></i>
            Pórtico <span id="monitor-selecionado"></span>
          </h1>
        </div>




        <div class="kpis-grid">
          <div class="kpi-card" id="kpiCpu">
            <div class="kpi-header">
              <div class="kpi-icon cpu">
                <i class="fas fa-microchip"></i>
              </div>
              <div class="kpi-info">
                <span class="kpi-label">CPU</span>
              </div>
            </div>
            <div class="kpi-value" id="kpiCpuValue">0%</div>
            <div class="kpi-progress">
              <div class="progress-bar cpu" id="cpuProgress"></div>
            </div>
            <a href="dashboard_CPU.html" class="kpi-detail-btn" title="Dashboard Detalhada - CPU">
              <i class="fas fa-chart-bar"></i>
              Ver detalhes
            </a>
          </div>

          <div class="kpi-card" id="kpiMemoria">
            <div class="kpi-header">
              <div class="kpi-icon memoria">
                <i class="fas fa-memory"></i>
              </div>
              <div class="kpi-info">
                <span class="kpi-label">Memória</span>
              </div>
            </div>
            <div class="kpi-value" id="kpiMemoriaValue">0%</div>
            <div class="kpi-progress">
              <div class="progress-bar memoria" id="memoriaProgress"></div>
            </div>
            <a href="memoria.html" class="kpi-detail-btn" title="Dashboard Detalhada - Memória">
              <i class="fas fa-chart-bar"></i>
              Ver detalhes
            </a>
          </div>

          <div class="kpi-card" id="kpiDisco">
            <div class="kpi-header">
              <div class="kpi-icon disco">
                <i class="fas fa-hdd"></i>
              </div>
              <div class="kpi-info">
                <span class="kpi-label">Disco</span>
              </div>
            </div>
            <div class="kpi-value" id="kpiDiscoValue">0%</div>
            <div class="kpi-progress">
              <div class="progress-bar disco" id="discoProgress"></div>
            </div>
            <a href="disco.html" class="kpi-detail-btn" title="Dashboard Detalhada - Disco">
              <i class="fas fa-chart-bar"></i>
              Ver detalhes
            </a>
          </div>

          <div class="kpi-card" id="kpiRede">
            <div class="kpi-header">
              <div class="kpi-icon rede">
                <i class="fas fa-network-wired"></i>
              </div>
              <div class="kpi-info">
                <span class="kpi-label">Rede</span>
              </div>
            </div>
            <div class="kpi-value" id="kpiRedeValue">0 Mbps</div>
            <div class="kpi-progress">
              <div class="progress-bar rede" id="redeProgress"></div>
            </div>
            <a href="dashbord_rede.html" class="kpi-detail-btn" title="Dashboard Detalhada - Rede">
              <i class="fas fa-chart-bar"></i>
              Ver detalhes
            </a>
          </div>
        </div>


        <div class="charts-grid">
          <div class="chart-container full-bleed">
            <div class="chart-header">
              <h3 class="chart-title">
                <i class="fas fa-pulse"></i>
                Atividade ao Vivo
              </h3>
            </div>
            <div class="chart-content">
              <canvas id="realTimeChart"></canvas>
            </div>
          </div>
        </div>


        <!-- <div class="alerts-section">
          <h2 class="section-title">
            <i class="fas fa-exclamation-triangle"></i>
            Alertas
          </h2>
          <div class="alerts-grid" id="alertsGrid">
            <!-- Alertas serão inseridos aqui assim que eu conseguir conectar o slack rs -->
        <!-- </div>
        </div> -->
        <!-- Bloco combinado: Status + Legenda lado a lado -->


        <div class="status-and-legend">
          <div class="status-card">
            <h3 class="status-title">
              <i class="fas fa-heartbeat"></i>
              Status do Sistema
            </h3>
            <div class="status-badge" id="systemStatus">Normal</div>
            <div class="status-description" id="statusDescription">
              Todos os componentes operando dentro dos parâmetros normais
            </div>
            <div class="status-metrics">
              <div class="metric">
                <span class="metric-label">Uptime:</span>
                <span class="metric-value" id="systemUptime">15d 8h 32m</span>
              </div>
              <div class="metric">
                <span class="metric-label">Alertas Ativos:</span>
                <span class="metric-value" id="alertCount">0</span>
              </div>
            </div>
          </div>

          <div class="legend-card">
            <h3 class="legend-title">
              <i class="fas fa-info-circle"></i>
              Legenda (Níveis de Monitoramento)
            </h3>

            <div class="legend-table-wrap">
              <table class="legend-table">
                <thead>
                  <tr>
                    <th>Componente</th>
                    <th>Utilização saudável</th>
                    <th>Alta utilização <small>(monitorar)*</small></th>
                    <th>Saturação <small>(crítico)</small></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>CPU (%)</td>
                    <td>20% – 45%</td>
                    <td><span class="pill warn">45% – 85%</span></td>
                    <td><span class="pill crit">&gt; 85%</span></td>
                  </tr>
                  <tr>
                    <td>Memória RAM (%)</td>
                    <td>40% – 53%</td>
                    <td><span class="pill warn">54% – 83%</span></td>
                    <td><span class="pill crit">&gt; 84%</span></td>
                  </tr>
                  <tr>
                    <td>Disco (%)</td>
                    <td>≤ 60%</td>
                    <td><span class="pill warn">80% – 90%</span></td>
                    <td><span class="pill crit">&gt; 90%</span></td>
                  </tr>
                  <tr>
                    <td>Rede (%)</td>
                    <td>≤ 50%</td>
                    <td><span class="pill warn">50% – 74%</span></td>
                    <td><span class="pill crit">&gt; ≥75%</span></td>
                  </tr>
                </tbody>
              </table>
              <div class="legend-note">
                * a partir de “Alta utilização” os alertas são ativados.
              </div>
            </div>
          </div>
        </div>

      </section>

      <section id="view-monitor" class="view">
        <div class="view-header">
          <h1 class="view-title">
            <i class="fas fa-chart-line"></i>
            Monitoramento (Histórico de Registros)
          </h1>
        </div>


        <div class="table-section">
          <div class="table-header">
            <h3 class="table-title">
              <i class="fas fa-table"></i>
              Últimas Leituras
            </h3>
            <div class="table-actions">
              <button id="exportMonitorCsv" class="btn btn-export">
                <i class="fas fa-download"></i>
                Exportar CSV
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th><i class="fas fa-server"></i> Pórtico</th>
                  <th><i class="fas fa-clock"></i> Horário</th>
                  <th><i class="fas fa-microchip"></i> CPU (%)</th>
                  <th><i class="fas fa-memory"></i> Memória (%)</th>
                  <th><i class="fas fa-hdd"></i> Disco (%)</th>
                  <th><i class="fas fa-network-wired"></i> Rede (Mbps)</th>
                </tr>
              </thead>
              <tbody id="monitorTableBody">
              </tbody>
            </table>
          </div>
          <div class="table-pagination">
            <div class="pagination-info">
              <span id="monitorPaginationInfo">Mostrando 0 de 0 registros</span>
            </div>
            <div class="pagination-controls">
              <button id="monitorPrevPage" class="btn btn-pagination" disabled>
                <i class="fas fa-chevron-left"></i>
                Anterior
              </button>
              <span id="monitorPageInfo">Página 0 de 0</span>
              <button id="monitorNextPage" class="btn btn-pagination" disabled>
                Próxima
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-cadastro" class="view">
        <div class="view-header">
          <h1 class="view-title">
            <i class="fas fa-pen-to-square"></i>
            Cadastro
          </h1>
        </div>

        <div class="cadastro-tabs">

          <button class="tab-btn" data-tab="usuario">
            <i class="fas fa-user"></i>
            Usuário
          </button>
          <button class="tab-btn" data-tab="maquina">
            <i class="fas fa-server"></i>
            Máquina
          </button>
        </div>

        <div class="cadastro-content">


          <div id="tab-usuario" class="tab-content active">



            <form class="cadastro-form" id="usuarioForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="usuarioNome">Nome</label>
                  <input type="text" id="usuarioNome" required>
                </div>
                <div class="form-group">
                  <label for="usuarioEmail">E-mail</label>
                  <input type="email" id="usuarioEmail" required>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="usuarioTipo">Tipo</label>
                  <select id="tipo_permissao" required>
                    <option value="0">Selecione uma opção</option>
                    <option value="1">Administrador</option>
                    <option value="2">Comum</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="usuarioSenha">Senha</label>
                  <input type="password" id="usuarioSenha" required>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  <span id="textoBotaoUsuario">Salvar</span>
                </button>

                <button type="reset" class="btn btn-secondary" id="cancelarEdicaoBtn">
                  <i class="fas fa-times"></i>
                  Cancelar
                </button>
              </div>
            </form>


            <div class="listar-users">
              <div class="titulo">
                <i class="bi bi-person-fill-add controlador"></i>
                <h1>Usuários Cadastrados</h1>
              </div>

              <div class="barra-infos">
                <p>ID</p>
                <p>Nome</p>
                <p>Email</p>
                <p>Acesso</p>
                <p>Ações</p>
              </div>

              <div id="usuariosContainer"></div>
            </div>


          </div>

          <div id="tab-maquina" class="tab-content">

  <!-- Formulário de cadastro -->
  <form class="cadastro-form" id="maquinaForm">
    <div class="form-row">
      <div class="form-group">
        <label for="maquinaNome">Nome</label>
        <input type="text" id="maquinaNome" required>
      </div>
      <div class="form-group">
        <label for="maquinaSo">Sistema Operacional</label>
        <input type="text" id="maquinaSo" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="maquinaLocalizacao">Localização</label>
        <input type="text" id="maquinaLocalizacao" required>
      </div>
      <div class="form-group">
        <label for="maquinaKm">KM</label>
        <input type="number" id="maquinaKm" step="0.1">
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i>
        <span id="textoBotaoMaquina">Salvar</span>
      </button>
      <button type="reset" class="btn btn-secondary" id="cancelarEdicaoMaquinaBtn">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
    </div>
  </form>

  <!-- Listagem de máquinas -->
  <div class="listar-maquinas">

    <div class="titulo">
      <i class="bi bi-hdd-stack controlador"></i>
      <h1>Pórticos Cadastrados</h1>
    </div>

    <div class="barra-infos-maq">
      <p>ID</p>
      <p>Nome</p>
      <p>Sistema Op.</p>
      <p>Localização</p>
      <p>KM</p>
      <p>Ações</p>
    </div>

    <div id="maquinasContainer"></div>
  </div>
</div>


        </div>
      </section>

    </main>
  </div>

  <script src="../js/dash.js"></script>

  <script>

  // VALIDAÇÕES
  function validarEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  }

  // ESTADO GLOBAL DE EDIÇÃO
  var usuarioEditandoId = null; 
  var maquinaEditandoId = null; 

  // CRUD - LISTAR USUÁRIOS
  function carregarUsuarios() {
    fetch("/usuarios/listar")
      .then(function (resposta) {
        if (!resposta.ok) {
          throw new Error("Erro ao listar usuários");
        }
        return resposta.json();
      })
      .then(function (lista) {
        var container = document.getElementById("usuariosContainer");
        if (!container) return;

        container.innerHTML = "";

        lista.forEach(function (user) {
          var div = document.createElement("div");
          div.className = "infos-user";

          var tipoTexto = user.tipo_permissao == 1 ? "Administrador" : "Comum";

          div.innerHTML = `
            <p>${user.idusuario}</p>
            <p>${user.nome}</p>
            <p>${user.email}</p>
            <p>${tipoTexto}</p>
            <div class="acoes"></div>
          `;

          var acoesDiv = div.querySelector(".acoes");

          var btnEditar = document.createElement("button");
          btnEditar.className = "btn_actions";
          btnEditar.innerHTML = `<i class="bi bi-pencil-square"></i>`;
          btnEditar.addEventListener("click", function () {
            prepararEdicaoUsuario(user);
          });

          var btnExcluir = document.createElement("button");
          btnExcluir.className = "btn_actions";
          btnExcluir.innerHTML = `<i class="bi bi-trash3-fill"></i>`;
          btnExcluir.addEventListener("click", function () {
            excluirUsuario(user.idusuario);
          });

          acoesDiv.appendChild(btnEditar);
          acoesDiv.appendChild(btnExcluir);

          container.appendChild(div);
        });
      })
      .catch(function (erro) {
        console.error(erro);
        alert("Não foi possível carregar os usuários.");
      });
  }

  // CRUD - PREPARAR EDIÇÃO USUÁRIO
  function prepararEdicaoUsuario(user) {
    var inputNome = document.getElementById("usuarioNome");
    var inputEmail = document.getElementById("usuarioEmail");
    var selectTipo = document.getElementById("tipo_permissao");
    var inputSenha = document.getElementById("usuarioSenha");
    var textoBotao = document.getElementById("textoBotaoUsuario");

    if (!inputNome || !inputEmail || !selectTipo || !inputSenha || !textoBotao) return;

    inputNome.value = user.nome;
    inputEmail.value = user.email;
    selectTipo.value = user.tipo_permissao;
    inputSenha.value = "";

    usuarioEditandoId = user.idusuario;
    textoBotao.textContent = "Atualizar";
  }

  // CRUD - CANCELAR EDIÇÃO USUÁRIO
  function cancelarEdicaoUsuario() {
    var inputNome = document.getElementById("usuarioNome");
    var inputEmail = document.getElementById("usuarioEmail");
    var selectTipo = document.getElementById("tipo_permissao");
    var inputSenha = document.getElementById("usuarioSenha");
    var textoBotao = document.getElementById("textoBotaoUsuario");

    if (inputNome) inputNome.value = "";
    if (inputEmail) inputEmail.value = "";
    if (selectTipo) selectTipo.value = "0";
    if (inputSenha) inputSenha.value = "";
    if (textoBotao) textoBotao.textContent = "Salvar";

    usuarioEditandoId = null;
  }

  // CRUD - SALVAR / ATUALIZAR USUÁRIO
  
  function enviarFormularioUsuario(event) {
    event.preventDefault();

    var inputNome = document.getElementById("usuarioNome");
    var inputEmail = document.getElementById("usuarioEmail");
    var selectTipo = document.getElementById("tipo_permissao");
    var inputSenha = document.getElementById("usuarioSenha");

    var nomeVar = inputNome.value;
    var emailUserVar = inputEmail.value;
    var tipoUserVar = selectTipo.value;
    var senhaUserVar = inputSenha.value;

    if (!nomeVar || !emailUserVar || !tipoUserVar || !senhaUserVar || tipoUserVar === "0") {
      alert("Preencha todos os campos obrigatórios!");
      return;
    }

    if (!validarEmail(emailUserVar)) {
      alert("Informe um e-mail válido.");
      return;
    }

    var url;
    var metodo;

    if (usuarioEditandoId) {
      url = `/usuarios/${usuarioEditandoId}`;
      metodo = "PUT";
    } else {
      url = "/usuarios/cadastrarUser";
      metodo = "POST";
    }

    fetch(url, {
      method: metodo,
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeServer: nomeVar,
        emailUserServer: emailUserVar,
        tipoUserServer: tipoUserVar,
        senhaUserServer: senhaUserVar
      }),
    })
      .then(async function (resposta) {
        if (resposta.ok) {
          if (usuarioEditandoId) {
            alert("Usuário atualizado com sucesso!");
          } else {
            alert("Usuário cadastrado com sucesso!");
          }

          cancelarEdicaoUsuario();
          carregarUsuarios();
        } else {
          var erro = await resposta.text();
          console.error(erro);
          alert("Houve um erro ao tentar salvar o usuário.");
        }
      })
      .catch(function (erro) {
        console.error(erro);
        alert("Erro de comunicação com o servidor.");
      });
  }

  
  // CRUD - EXCLUIR USUÁRIO
  
  function excluirUsuario(id) {
    if (!confirm("Deseja realmente excluir este usuário?")) {
      return;
    }

    fetch(`/usuarios/${id}`, {
      method: "DELETE"
    })
      .then(function (resposta) {
        if (resposta.ok) {
          alert("Usuário excluído com sucesso!");

          if (usuarioEditandoId === id) {
            cancelarEdicaoUsuario();
          }

          carregarUsuarios();
        } else {
          alert("Não foi possível excluir o usuário.");
        }
      })
      .catch(function (erro) {
        console.error(erro);
        alert("Erro de comunicação com o servidor.");
      });
  }

  // ========================= CRUD MÁQUINA ===============================

  // LISTAR MÁQUINAS DA EMPRESA LOGADA
  function carregarMaquinas() {
    var idEmpresa = sessionStorage.ID_EMPRESA || 1; // fallback 1 se algo vier vazio

    fetch(`/maquinas/listar/${idEmpresa}`)
      .then(function (resposta) {
        if (resposta.status === 204) {
          return [];
        }
        if (!resposta.ok) {
          throw new Error("Erro ao listar máquinas");
        }
        return resposta.json();
      })
      .then(function (lista) {
        var container = document.getElementById("maquinasContainer");
        if (!container) return;

        container.innerHTML = "";

        lista.forEach(function (maq) {
          var div = document.createElement("div");
          div.className = "infos-maquina";

          div.innerHTML = `
            <p>${maq.id_maquina}</p>
            <p>${maq.nome_maquina}</p>
            <p>${maq.so}</p>
            <p>${maq.localizacao}</p>
            <p>${maq.km}</p>
            <div class="acoes"></div>
          `;

          var acoesDiv = div.querySelector(".acoes");

          var btnEditar = document.createElement("button");
          btnEditar.className = "btn_actions";
          btnEditar.innerHTML = `<i class="bi bi-pencil-square"></i>`;
          btnEditar.addEventListener("click", function () {
            prepararEdicaoMaquina(maq);
          });

          var btnExcluir = document.createElement("button");
          btnExcluir.className = "btn_actions";
          btnExcluir.innerHTML = `<i class="bi bi-trash3-fill"></i>`;
          btnExcluir.addEventListener("click", function () {
            excluirMaquina(maq.id_maquina);
          });

          acoesDiv.appendChild(btnEditar);
          acoesDiv.appendChild(btnExcluir);

          container.appendChild(div);
        });
      })
      .catch(function (erro) {
        console.error(erro);
        alert("Não foi possível carregar as máquinas.");
      });
  }

  // PREPARAR EDIÇÃO MÁQUINA
  function prepararEdicaoMaquina(maq) {
    var inputNome = document.getElementById("maquinaNome");
    var inputSo = document.getElementById("maquinaSo");
    var inputLocal = document.getElementById("maquinaLocalizacao");
    var inputKm = document.getElementById("maquinaKm");
    var textoBotao = document.getElementById("textoBotaoMaquina");

    if (!inputNome || !inputSo || !inputLocal || !inputKm || !textoBotao) return;

    inputNome.value = maq.nome_maquina;
    inputSo.value = maq.so;
    inputLocal.value = maq.localizacao;
    inputKm.value = maq.km;

    maquinaEditandoId = maq.id_maquina;
    textoBotao.textContent = "Atualizar";
  }

  // CANCELAR EDIÇÃO MÁQUINA
  function cancelarEdicaoMaquina() {
    var inputNome = document.getElementById("maquinaNome");
    var inputSo = document.getElementById("maquinaSo");
    var inputLocal = document.getElementById("maquinaLocalizacao");
    var inputKm = document.getElementById("maquinaKm");
    var textoBotao = document.getElementById("textoBotaoMaquina");

    if (inputNome) inputNome.value = "";
    if (inputSo) inputSo.value = "";
    if (inputLocal) inputLocal.value = "";
    if (inputKm) inputKm.value = "";
    if (textoBotao) textoBotao.textContent = "Salvar";

    maquinaEditandoId = null;
  }

  // SALVAR / ATUALIZAR MÁQUINA
  function enviarFormularioMaquina(event) {
    event.preventDefault();

    var inputNome = document.getElementById("maquinaNome");
    var inputSo = document.getElementById("maquinaSo");
    var inputLocal = document.getElementById("maquinaLocalizacao");
    var inputKm = document.getElementById("maquinaKm");

    var nomeVar = inputNome.value.trim();
    var soVar = inputSo.value.trim();
    var localVar = inputLocal.value.trim();
    var kmVar = inputKm.value.trim();
    var idEmpresa = sessionStorage.ID_EMPRESA || 1;

    if (!nomeVar || !soVar || !localVar) {
      alert("Preencha pelo menos Nome, Sistema Operacional e Localização da máquina.");
      return;
    }

    var url;
    var metodo;
    var body;

    if (maquinaEditandoId) {
      // UPDATE
      url = `/maquinas/${maquinaEditandoId}`;
      metodo = "PUT";
      body = {
        nome_maquina: nomeVar,
        so: soVar,
        localizacao: localVar,
        km: kmVar
      };
    } else {
      // INSERT
      url = "/maquinas/cadastrar";
      metodo = "POST";
      body = {
        nome_maquina: nomeVar,
        so: soVar,
        localizacao: localVar,
        km: kmVar,
        fk_empresa_maquina: idEmpresa
      };
    }

    fetch(url, {
      method: metodo,
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    })
      .then(async function (resposta) {
        if (resposta.ok) {
          if (maquinaEditandoId) {
            alert("Máquina atualizada com sucesso!");
          } else {
            alert("Máquina cadastrada com sucesso!");
          }

          cancelarEdicaoMaquina();
          carregarMaquinas();
        } else {
          var erro = await resposta.text();
          console.error(erro);
          alert("Houve um erro ao tentar salvar a máquina.");
        }
      })
      .catch(function (erro) {
        console.error(erro);
        alert("Erro de comunicação com o servidor.");
      });
  }

  // EXCLUIR MÁQUINA
  function excluirMaquina(id) {
    if (!confirm("Deseja realmente excluir esta máquina?")) {
      return;
    }

    fetch(`/maquinas/${id}`, {
      method: "DELETE"
    })
      .then(function (resposta) {
        if (resposta.ok) {
          alert("Máquina excluída com sucesso!");

          if (maquinaEditandoId === id) {
            cancelarEdicaoMaquina();
          }

          carregarMaquinas();
        } else {
          alert("Não foi possível excluir a máquina.");
        }
      })
      .catch(function (erro) {
        console.error(erro);
        alert("Erro de comunicação com o servidor.");
      });
  }

  function criarBotaoSuporteJira() {
    const linkBotao = document.createElement('a');
    linkBotao.innerHTML = `
      <img src="../assets/icon/iconeJira.png" alt="Ícone de Suporte" width="24" height="24" />
      Suporte
    `;
    linkBotao.title = "Acessar o Help Desk do Jira";
    linkBotao.href = "https://infraflow-sptech.atlassian.net/servicedesk/customer/portal/2";
    linkBotao.target = "_blank";
    linkBotao.style.cssText = `
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      margin: 0;
      padding: 12px 24px;
      border-radius: 50px;
      border: none;
      text-decoration: none;
      background-color: #0052CC;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      font-weight: 600;
      font-size: 16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    `;

    linkBotao.onmouseover = function () {
      linkBotao.style.backgroundColor = '#0065FF';
      linkBotao.style.boxShadow = '0 6px 16px rgba(0, 0, 0, 0.3)';
    };
    linkBotao.onmouseout = function () {
      linkBotao.style.backgroundColor = '#0052CC';
      linkBotao.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.25)';
      linkBotao.style.transform = 'scale(1)';
    };

    linkBotao.onmousedown = function () {
      linkBotao.style.transform = 'scale(0.98)';
    };

    linkBotao.onmouseup = function () {
      linkBotao.style.transform = 'scale(1)';
    };

    document.body.appendChild(linkBotao);
  }

  (function () {
    function initNav() {
      const navItems = Array.from(document.querySelectorAll('.nav-item'));
      const views = Array.from(document.querySelectorAll('.view'));

      navItems.forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.getAttribute('data-view');
          if (!view) return;

          navItems.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          views.forEach(v => v.classList.remove('active'));
          const target = document.getElementById('view-' + view);
          if (target) target.classList.add('active');

          if (view === "cadastro") {
            carregarUsuarios();
            carregarMaquinas();
          }
        });
      });
    }

    function initCadastroTabs() {
      const btns = Array.from(document.querySelectorAll('.cadastro-tabs .tab-btn'));
      const tabs = Array.from(document.querySelectorAll('.cadastro-content .tab-content'));
      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          btns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          tabs.forEach(t => t.classList.remove('active'));
          const target = document.getElementById('tab-' + tab);
          if (target) target.classList.add('active');

          if (tab === "usuario") {
            carregarUsuarios();
          } else if (tab === "maquina") {
            carregarMaquinas();
          }
        });
      });
    }

    function initLogout() {
      const btn = document.getElementById('logoutBtn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        try { sessionStorage.clear(); localStorage.removeItem('login_email'); } catch (e) { }
        window.location.replace('../login.html');
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      initNav();
      initCadastroTabs();
      initLogout();
      criarBotaoSuporteJira();

      var formUsuario = document.getElementById("usuarioForm");
      if (formUsuario) {
        formUsuario.addEventListener("submit", enviarFormularioUsuario);
      }

      var btnCancelar = document.getElementById("cancelarEdicaoBtn");
      if (btnCancelar) {
        btnCancelar.addEventListener("click", function () {
          cancelarEdicaoUsuario();
        });
      }

      var formMaquina = document.getElementById("maquinaForm");
      if (formMaquina) {
        formMaquina.addEventListener("submit", enviarFormularioMaquina);
      }

      var btnCancelarMaq = document.getElementById("cancelarEdicaoMaquinaBtn");
      if (btnCancelarMaq) {
        btnCancelarMaq.addEventListener("click", function () {
          cancelarEdicaoMaquina();
        });
      }

      carregarUsuarios();
      carregarMaquinas();
    });
  })();
</script>


</body>

</html>