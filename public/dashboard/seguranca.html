<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CyberFlow - Painel de Seguran√ßa</title>
  <link rel="stylesheet" href="../css/seguranca.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar-left {
      background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-dark) 100%) !important;
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .sidebar-right {
      background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-dark) 100%) !important;
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .sidebar-home {
      display: flex;
      justify-content: flex-start;
      padding: 0.75rem 0.75rem 0.25rem 0.75rem;
    }

    .sidebar-home-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
      cursor: pointer;
      transition: var(--transition-fast);
      text-decoration: none;
      font-size: 0.95rem;
      flex-shrink: 0;
    }

    .sidebar-home-btn:hover {
      background: rgba(255, 255, 255, 0.16);
      transform: translateY(-1px);
      color: #ffffff;
    }


    .sidebar-card li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      text-align: left;
      cursor: pointer;
      transition: var(--transition-fast);
      font-size: 0.95rem;
      font-weight: 500;
      width: 100%;
      border-radius: 0;
    }

    .sidebar-card li:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: none;
    }

    .sidebar-card li i {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    .user-section {
      padding: 1rem 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.875rem;
    }

    .user-info i {
      font-size: 1.25rem;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.8);
      padding: 0.5rem;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition-fast);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .logs-card {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .logs-card h3 {
      font-size: 1rem;
      font-weight: 700;
      color: white;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logs-container {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius);
      padding: 1rem;
    }

    .log-item {
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      border-left: 3px solid var(--gray-300);
      border-radius: 0.35rem;
      color: white;
      line-height: 1.4;
      word-break: break-word;
    }

    .topbar {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    :root {
      --primary-color: #008080;
      --primary-dark: #006060;
      --primary-light: #06afaf;
      --secondary-color: #059669;
      --accent-color: #7c3aed;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #3b82f6;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --sidebar-width: 280px;
      --topbar-height: 70px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --transition-fast: 150ms ease-in-out;
      --transition-normal: 250ms ease-in-out;
      --transition-slow: 350ms ease-in-out;
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
    }

    .modal-telefones.hidden-modal {
      display: none;
    }

    .modal-telefones {
      position: fixed;
      inset: 0;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-telefones-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
    }

    .modal-telefones-content {
      position: relative;
      background: #0f172a;
      color: #f9fafb;
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 420px;
    }

    .modal-telefones-content h3 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .modal-telefones-content ul {
      list-style: none;
      padding: 0;
      margin: 0 0 1.25rem 0;
      font-size: 0.9rem;
    }

    .modal-telefones-content ul li {
      margin-bottom: 0.5rem;
    }

    .modal-telefones-content button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: none;
      background: var(--primary-color);
      color: #f9fafb;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .modal-telefones-content button:hover {
      background: var(--primary-dark);
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 10px;
      cursor: default;
      position: relative;
      color: #94a3b8;
      flex-shrink: 0;
    }

    .info-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 125%;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 8px;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      line-height: 1.2;
      white-space: normal;
      min-width: 160px;
      max-width: 220px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out;
      box-shadow: var(--shadow-lg);
      z-index: 50;
    }

    .info-icon:hover::after {
      opacity: 1;
      transform: translate(-50%, -6px);
    }

    .chart-header h3 {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-brand">
      <a href="dashboard.html">
        <img src="../assets/infra-parafundobranco.png" alt="InfraFlow" class="brand-logo">
      </a>
    </div>

    <div class="topbar-center">
      <div class="machine-select">
        <i class="fas fa-server"></i>
        <div class="select-wrapper">
          <label for="edgeSelector">P√≥rtico FreeFlow</label>
          <select id="edgeSelector">
            <option>INFRA-EDGE-01-It√°polis (SP-333)</option>
          </select>
        </div>
      </div>
      <div class="os-badge">
        <i class="fab fa-ubuntu"></i>
        <span>Ubuntu 22.04 LTS</span>
      </div>
    </div>

    <div class="topbar-right">
      <div class="status-pill">
        <div class="status-dot"></div>
        <span>Online</span>
      </div>
      <div class="last-update">
        <span class="label">Atualizado:</span>
        <span class="time" id="lastUpdateTime">--:--:--</span>
      </div>
    </div>
  </header>

  <main class="cyber-container">
    <aside class="sidebar-left">
      <div class="sidebar-card">
        <h3>A√ß√µes R√°pidas</h3>
        <ul>
          <li id="btnTelefones"><i class="fas fa-phone"></i> Contatos de emerg√™ncia</li>
          <li id="btnRegistrarEvento"><i class="fas fa-file-alt"></i> Registrar incidente</li>
        </ul>
      </div>

      <div class="user-section">
        <div class="user-info">
          <i class="fas fa-user-circle"></i>
          <span id="sidebarUser">Admin</span>
        </div>
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </aside>

    <section class="main-content">
      <div class="content-header">
        <div>
          <h1 class="title">CyberFlow - NOC/SOC</h1>
          <p class="subtitle">Proteger, Detectar e Responder</p>
        </div>
      </div>

      <section class="kpis-section">
        <div class="kpi-card">
          <div class="kpi-icon shield">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div class="kpi-body">
            <p class="kpi-label">
              Vers√£o do Kernel
              <span class="info-icon"
                data-tooltip="Kernel atualizado reduz exposi√ß√£o a vulnerabilidades cr√≠ticas do sistema.">i</span>
            </p>
            <p class="kpi-value" id="status-operacao">Normal</p>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon users">
            <i class="fas fa-user-group"></i>
          </div>
          <div class="kpi-body">
            <p class="kpi-label">
              Usu√°rios Logados
              <span class="info-icon"
                data-tooltip="Total de sess√µes ativas neste p√≥rtico de FreeFlow. Ajuda a identificar acessos an√¥malos.">i</span>
            </p>
            <p class="kpi-value" id="usuarios-logados">2</p>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon warning">
            <i class="fas fa-user-lock"></i>
          </div>
          <div class="kpi-body">
            <p class="kpi-label">
              Acessos N√£o Autorizado (24h)
              <span class="info-icon"
                data-tooltip="Tentativas de login ou acesso bloqueadas nas √∫ltimas 24 horas.">i</span>
            </p>
            <p class="kpi-value" id="tentativas-ataque">1</p>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon lock">
            <i class="fas fa-video"></i>
          </div>
          <div class="kpi-body">
            <p class="kpi-label">
              Falhas de Captura por C√¢mera (24h)
              <span class="info-icon"
                data-tooltip="Quantidade de falhas de captura de imagem registradas nas √∫ltimas 24 horas.">i</span>
            </p>
            <p class="kpi-value" id="falhas-camera-24h">0</p>
          </div>
        </div>
      </section>

      <div class="content-grid">
        <article class="card">
          <div class="chart-header">
            <h3>
              Alertas Operacionais (24h)
              <span class="info-icon"
                data-tooltip="Lista qualitativa de alertas gerados pelos componentes monitorados nas √∫ltimas 24 horas.">i</span>
            </h3>
          </div>
          <div class="alertas-container" id="alertasOperacionais">
            <div class="loading-alertas">Carregando alertas...</div>
          </div>
        </article>

        <article class="card full-width">
          <div class="chart-header">
            <h3>
              Gr√°fico de Alertas Operacionais (24h)
              <span class="info-icon"
                data-tooltip="Histograma de alertas por hora nas √∫ltimas 24 horas, baseado na tabela de alertas do p√≥rtico.">i</span>
            </h3>
          </div>
          <div class="chart-wrapper">
            <canvas id="cyberAccessChart"></canvas>
          </div>
        </article>

        <article class="card large">
          <h3>
            Insight Autom√°tico ‚Äì BobIA
            <span class="info-icon"
              data-tooltip="Resumo em linguagem natural gerado a partir dos eventos recentes do painel de logs.">i</span>
          </h3>
          <p id="ia-insight">
            Aguardando an√°lise dos eventos de seguran√ßa...
          </p>
        </article>

        <article class="card">
          <h3>
            C√¢mera Ao Vivo - Porta Principal
            <span class="info-icon"
              data-tooltip="Feed simulado de v√≠deo do p√≥rtico FreeFlow ou, em modo demo, a webcam do operador.">i</span>
          </h3>

          <div class="camera-placeholder">

            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 8px;">
              <button id="btnModoMock"
                style="padding: 4px 8px; font-size: 11px; border-radius: 6px; border: 1px solid #cbd5e1; background:#e2e8f0; cursor:pointer;">
                Modo Simulado
              </button>
              <button id="btnModoWebcam"
                style="padding: 4px 8px; font-size: 11px; border-radius: 6px; border: 1px solid #0f766e; background:#0d9488; color:#fff; cursor:pointer;">
                Modo Webcam (Demo)
              </button>
            </div>

            <!-- MODO V√çDEO MOCKADO -->
            <div id="cameraMockContainer"
              style="position: relative; width: 100%; border-radius: 8px; overflow: hidden; background: #000;">
              <video id="videoMock" width="100%" height="315" autoplay loop muted style="display: block;">
                <source src="../assets/freeflow.mp4" type="video/mp4">
              </video>
              <div
                style="position: absolute; top: 10px; left: 10px; background: rgba(255,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                ‚óè LIVE (Simulado)
              </div>
              <div
                style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                üìç Porta Principal - P√≥rtico FreeFlow
              </div>
              <div
                style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                üïí <span id="live-time">--:--:--</span>
              </div>
            </div>

            <!-- MODO WEBCAM -->
            <div id="cameraWebcamContainer"
              style="position: relative; width: 100%; border-radius: 8px; overflow: hidden; background: #000; display:none;">
              <video id="videoWebcam" width="100%" height="315" autoplay playsinline muted
                style="display:block;"></video>
              <div
                style="position: absolute; top: 10px; left: 10px; background: rgba(34,197,94,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                ‚óè LIVE (Webcam Demo)
              </div>
              <div
                style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                üë§ Operador - Posi√ß√£o de Monitoramento
              </div>
              <div
                style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                üïí <span id="live-time-webcam">--:--:--</span>
              </div>
            </div>

            <p style="margin-top: 10px; text-align: center; color: #666; font-size: 12px;">
              Modo demo: utilize a webcam do operador para simular monitoramento em tempo real.
            </p>
          </div>
        </article>

      </div>

    </section>

    <aside class="sidebar-right">
      <div class="sidebar-card logs-card">
        <h3>Painel de Logs</h3>
        <div id="cyberLogs" class="logs-container"></div>
      </div>
    </aside>
  </main>

  <div id="modalTelefones" class="modal-telefones hidden-modal">
    <div class="modal-telefones-backdrop"></div>
    <div class="modal-telefones-content">
      <h3>Contatos de Emerg√™ncia</h3>
      <ul>
        <li><strong>NOC Central:</strong> 0800 123 456</li>
        <li><strong>Supervisor de Plant√£o:</strong> (11) 99999-0000</li>
        <li><strong>Seguran√ßa Vi√°ria:</strong> 190</li>
        <li><strong>Concession√°ria:</strong> 0800 333 2025</li>
      </ul>
      <button id="fecharModalTelefones">Fechar</button>
    </div>
  </div>

  <script src="../js/seguranca.js"></script>

  <script>
    const logStyles = `
<style>
.log-item {
    padding: 8px 12px;
    margin-bottom: 6px;
    border-left: 3px solid #4a90e2;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    animation: fadeIn 0.5s;
}
.log-item.warning {
    border-left-color: #f0ad4e;
    background: rgba(240, 173, 78, 0.08);
}
.log-item.error {
    border-left-color: #d9534f;
    background: rgba(217, 83, 79, 0.08);
}
.log-time {
    font-size: 0.7em;
    color: #8899a6;
    font-weight: 500;
}
.log-message {
    font-size: 0.8em;
    margin-top: 2px;
    color: #e1e8ed;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
`;
    document.head.insertAdjacentHTML('beforeend', logStyles);
  </script>

  <script>
    let contadorTentativas = 0;
    let ultimoInsightChamadaMs = -Infinity;
    let cyberAccessChart = null;
    let logsPainel = [];
    let webcamStream = null;

    document.getElementById('logoutBtn').addEventListener('click', async function () {
      try {
        const idUsuario =
          sessionStorage.ID_USUARIO ||
          sessionStorage.id_usuario ||
          sessionStorage.ID_USUARIO_LOGADO ||
          null;

        if (idUsuario) {
          await fetch('/usuarios/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_usuario: idUsuario })
          });
        }
      } catch (e) {
        console.error("Erro ao chamar logout backend:", e);
      }

      try {
        sessionStorage.clear();
        localStorage.removeItem('login_email');
      } catch (e) { }

      window.location.replace('../login.html');
    });


    const btnTelefones = document.getElementById('btnTelefones');
    const modalTelefones = document.getElementById('modalTelefones');
    const fecharModalTelefones = document.getElementById('fecharModalTelefones');
    const btnRegistrarEvento = document.getElementById('btnRegistrarEvento');

    function abrirModalTelefones() {
      if (!modalTelefones) return;
      modalTelefones.classList.remove('hidden-modal');
    }

    function fecharModal() {
      if (!modalTelefones) return;
      modalTelefones.classList.add('hidden-modal');
    }

    if (btnTelefones) {
      btnTelefones.addEventListener('click', abrirModalTelefones);
    }

    if (fecharModalTelefones) {
      fecharModalTelefones.addEventListener('click', fecharModal);
    }

    const backdropTelefones = modalTelefones ? modalTelefones.querySelector('.modal-telefones-backdrop') : null;
    if (backdropTelefones) {
      backdropTelefones.addEventListener('click', fecharModal);
    }

    if (btnRegistrarEvento) {
      btnRegistrarEvento.addEventListener('click', function () {
        const msg = prompt('Descreva o incidente de seguran√ßa registrado:');
        if (!msg || !msg.trim()) return;
        const logsContainer = document.getElementById('cyberLogs');
        if (!logsContainer) return;
        const logElement = document.createElement('div');
        logElement.className = 'log-item info';
        logElement.innerHTML = `
          <div class="log-time">${new Date().toLocaleTimeString('pt-BR')}</div>
          <div class="log-message">${msg.trim()}</div>
        `;
        logsContainer.prepend(logElement);
      });
    }

    async function atualizarKernelReal() {
      const el = document.getElementById('status-operacao');
      if (!el) return;

      try {
        const resp = await fetch('/api/seguranca/kernel');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);

        const data = await resp.json();
        el.textContent = data.kernel || 'Indispon√≠vel';
      } catch (e) {
        console.error('Erro ao buscar kernel:', e);
        el.textContent = 'Indispon√≠vel';
      }
    }

    function atualizarInformacoes() {
      const userEmail = localStorage.getItem('login_email');
      if (userEmail) {
        document.getElementById('sidebarUser').textContent = userEmail.split('@')[0];
      }
      atualizarKernelReal();

      document.getElementById('lastUpdateTime').textContent =
        new Date().toLocaleTimeString('pt-BR');
    }

    function atualizarHoraLive() {
      const el = document.getElementById('live-time');
      if (!el) return;
      el.textContent = new Date().toLocaleTimeString('pt-BR');
    }

    async function gerarInsightDeLogs(logs) {
      const agora = Date.now();
      if (agora - ultimoInsightChamadaMs < 20 * 60 * 1000) return;
      if (!Array.isArray(logs) || logs.length === 0) return;

      const indices = [];
      const max = Math.min(8, logs.length);
      while (indices.length < max) {
        const idx = Math.floor(Math.random() * logs.length);
        if (!indices.includes(idx)) indices.push(idx);
      }

      const escolhidos = indices.map(i => logs[i]);
      const contextoBase = escolhidos
        .map(l => `${new Date(l.timestamp).toISOString()} - ${l.message}`)
        .join('\n');

      const contexto = contextoBase + '\nPING:' + agora;

      if (!contexto.trim()) return;

      try {
        const resp = await fetch('/ia/insight', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contexto })
        });

        const data = await resp.json();
        const alvo = document.getElementById('ia-insight');

        if (alvo) {
          alvo.textContent =
            data.insight || 'Aguardando novos eventos de seguran√ßa...';
        }

        ultimoInsightChamadaMs = agora;
      } catch (e) {
        const alvo = document.getElementById('ia-insight');
        if (alvo) {
          alvo.textContent =
            'N√£o foi poss√≠vel gerar insight agora. Aguardando novos eventos de seguran√ßa.';
        }
      }
    }

    function atualizarGraficoAlertas(alertas) {
      const canvas = document.getElementById('cyberAccessChart');
      if (!canvas) return;

      const labels = [];
      const data = [];
      const counts = new Array(24).fill(0);

      alertas.forEach(alerta => {
        const d = new Date(alerta.data_hora_captura);
        const h = d.getHours();
        if (!isNaN(h)) counts[h]++;
      });

      for (let h = 0; h < 24; h++) {
        labels.push(h.toString().padStart(2, '0') + 'h');
        data.push(counts[h]);
      }

      if (cyberAccessChart) {
        cyberAccessChart.destroy();
      }

      const valueLabelsPlugin = {
        id: 'valueLabels',
        afterDatasetsDraw(chart, args, pluginOptions) {
          const { ctx } = chart;
          const dataset = chart.data.datasets[0];
          const meta = chart.getDatasetMeta(0);

          ctx.save();
          meta.data.forEach((bar, index) => {
            const value = dataset.data[index];
            if (!value) return;

            const x = bar.x;
            const y = bar.y - 4;

            ctx.font = '10px Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillStyle = '#0f172a';
            ctx.fillText(value, x, y);
          });
          ctx.restore();
        }
      };

      cyberAccessChart = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Alertas por hora (24h)',
            data,
            backgroundColor: 'rgba(0, 128, 128, 0.6)',
            borderColor: 'rgba(0, 128, 128, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                maxRotation: 0,
                autoSkip: true
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              },
              title: {
                display: true,
                text: 'Quantidade de alertas'
              }
            }
          },
          plugins: {
            legend: {
              display: true
            }
          }
        },
        plugins: [valueLabelsPlugin]
      });
    }

    async function carregarDadosSeguranca() {
      try {
        const responseStats = await fetch('/usuarios/estatisticas-seguranca');
        const stats = await responseStats.json();

        contadorTentativas = stats.tentativasAtaque;
        document.getElementById('tentativas-ataque').textContent = contadorTentativas;

        var kpiUsuarios = document.getElementById('usuarios-logados');
        if (kpiUsuarios) {
          kpiUsuarios.textContent = Number(stats.usuariosLogados || 0);
        }

        if (logsPainel.length) {
          await gerarInsightDeLogs(logsPainel);
        }
      } catch (error) {
        document.getElementById('tentativas-ataque').textContent = contadorTentativas;
      }
    }


    async function carregarAlertasOperacionais() {
      try {
        const response = await fetch('/api/seguranca/alertas-operacionais');

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        const alertas = await response.json();
        const container = document.getElementById('alertasOperacionais');
        container.innerHTML = '';

        if (!alertas.length) {
          container.innerHTML = '<div class="alerta-item">Nenhum alerta nas √∫ltimas 24 horas</div>';
          atualizarGraficoAlertas(alertas);
          return;
        }

        alertas.forEach(alerta => {
          const alertaElement = document.createElement('div');

          let tipoClasse = 'info';
          if (alerta.nivel_gravidade === 'CR√çTICO') {
            tipoClasse = 'alta';
          } else if (alerta.nivel_gravidade === 'ALTO' || alerta.nivel_gravidade === 'ATEN√á√ÉO') {
            tipoClasse = 'atencao';
          }

          alertaElement.className = `alerta-item ${tipoClasse}`;

          const timestamp = new Date(alerta.data_hora_captura);
          const tempoFormatado = timestamp.toLocaleTimeString('pt-BR');
          const dataFormatada = timestamp.toLocaleDateString('pt-BR');

          alertaElement.innerHTML = `
        <div class="alerta-header">
          <span class="alerta-tipo">${alerta.nome_componente} - ${alerta.nivel_gravidade}</span>
          <span class="alerta-tempo" title="${dataFormatada} ${tempoFormatado}">${tempoFormatado}</span>
        </div>
        <div class="alerta-mensagem">${alerta.descricao}</div>
        <div class="alerta-detalhes">
          M√°quina: ${alerta.nome_maquina} | Valor: ${alerta.valor_atual}${alerta.unidade_de_medida}
        </div>
      `;

          container.appendChild(alertaElement);
        });

        atualizarGraficoAlertas(alertas);
      } catch (error) {
        document.getElementById('alertasOperacionais').innerHTML =
          '<div class="alerta-item atencao">Erro ao carregar alertas: ' + error.message + '</div>';
      }
    }

    function atualizarInformacoes() {
      const userEmail = localStorage.getItem('login_email');
      if (userEmail) {
        document.getElementById('sidebarUser').textContent = userEmail.split('@')[0];
      }
      atualizarKernelReal();

      document.getElementById('lastUpdateTime').textContent =
        new Date().toLocaleTimeString('pt-BR');
    }

    function atualizarKpiUsuarios() {
      fetch('/usuarios/estatisticas-seguranca')
        .then(r => r.json())
        .then(stats => {
          var kpi = document.getElementById('usuarios-logados');
          if (kpi) {
            kpi.textContent = Number(stats.usuariosLogados || 0);
          }
        })
        .catch(() => { });
    }

    atualizarKpiUsuarios();

    async function carregarLogsDaEc2() {
      const logsContainer = document.getElementById('cyberLogs');
      const endpoint = "http://ec2-3-94-244-74.compute-1.amazonaws.com:3001/logs";

      if (!logsContainer) return;

      try {
        const resposta = await fetch(endpoint);
        if (!resposta.ok) throw new Error("Erro ao acessar logs da EC2");

        const textoBruto = await resposta.text();
        const linhas = textoBruto.split("\n").filter(l => l.trim());

        logsContainer.innerHTML = "";
        logsPainel = [];

        linhas.slice(-200).forEach(linha => {
          const tipo =
            linha.toLowerCase().includes("error") ? "error" :
              linha.toLowerCase().includes("warn") ? "warning" :
                "info";

          const registro = {
            timestamp: new Date(),
            message: linha,
            type: tipo
          };

          logsPainel.push(registro);

          const logDiv = document.createElement("div");
          logDiv.classList.add("log-item", tipo);
          logDiv.innerHTML = `
        <div class="log-time">${registro.timestamp.toLocaleTimeString('pt-BR')}</div>
        <div class="log-message">${registro.message}</div>
      `;
          logsContainer.prepend(logDiv);
        });

        // alimenta o BobIA com os logs reais
        await gerarInsightDeLogs(logsPainel);

      } catch (e) {
        console.warn("Falha ao buscar logs da EC2 ‚Äî usando fallback:", e);

        const fallback = [
          "[FALLBACK] N√£o foi poss√≠vel conectar √† EC2.",
          "[FALLBACK] Verifique a rede, security group ou porta.",
          "[FALLBACK] Logs simulados ativados."
        ];

        logsContainer.innerHTML = "";
        logsPainel = [];

        fallback.forEach(msg => {
          const registro = {
            timestamp: new Date(),
            message: msg,
            type: "warning"
          };

          logsPainel.push(registro);

          const logDiv = document.createElement("div");
          logDiv.classList.add("log-item", "warning");
          logDiv.innerHTML = `
        <div class="log-time">${registro.timestamp.toLocaleTimeString('pt-BR')}</div>
        <div class="log-message">${registro.message}</div>
      `;
          logsContainer.appendChild(logDiv);
        });

        await gerarInsightDeLogs(logsPainel);
      }
    }

    function atualizarHoraWebcam() {
      const el = document.getElementById('live-time-webcam');
      if (!el) return;
      el.textContent = new Date().toLocaleTimeString('pt-BR');
    }

    async function iniciarWebcamDemo() {
      const webcamContainer = document.getElementById('cameraWebcamContainer');
      const mockContainer = document.getElementById('cameraMockContainer');
      const videoWebcam = document.getElementById('videoWebcam');
      const videoMock = document.getElementById('videoMock');

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Seu navegador n√£o suporta acesso √† webcam.');
        return;
      }

      try {
        if (videoMock) {
          videoMock.pause();
        }

        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        webcamStream = stream;

        if (videoWebcam) {
          videoWebcam.srcObject = stream;
        }

        if (mockContainer) mockContainer.style.display = 'none';
        if (webcamContainer) webcamContainer.style.display = 'block';

      } catch (err) {
        console.error('Erro ao acessar webcam:', err);
        alert('N√£o foi poss√≠vel acessar a webcam. Verifique permiss√µes do navegador.');
      }
    }

    function pararWebcamDemo() {
      const webcamContainer = document.getElementById('cameraWebcamContainer');
      const mockContainer = document.getElementById('cameraMockContainer');
      const videoWebcam = document.getElementById('videoWebcam');
      const videoMock = document.getElementById('videoMock');

      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
      }

      if (videoWebcam) {
        videoWebcam.srcObject = null;
      }

      if (mockContainer) mockContainer.style.display = 'block';
      if (webcamContainer) webcamContainer.style.display = 'none';

      if (videoMock) {
        videoMock.play().catch(() => { });
      }
    }


    document.addEventListener('DOMContentLoaded', function () {
      const btnModoMock = document.getElementById('btnModoMock');
      const btnModoWebcam = document.getElementById('btnModoWebcam');
      if (btnModoWebcam) {
        btnModoWebcam.addEventListener('click', iniciarWebcamDemo);
      }
      if (btnModoMock) {
        btnModoMock.addEventListener('click', pararWebcamDemo);
      }
      atualizarInformacoes();
      atualizarHoraLive();
      carregarDadosSeguranca();
      carregarAlertasOperacionais();
      carregarLogsDaEc2();
    });

    setInterval(atualizarInformacoes, 60000);
    setInterval(carregarDadosSeguranca, 30000);
    setInterval(carregarAlertasOperacionais, 30000);
    setInterval(atualizarHoraLive, 1000);
    setInterval(atualizarKpiUsuarios, 5000);
    setInterval(carregarLogsDaEc2, 5000);
    setInterval(atualizarHoraWebcam, 1000);
  </script>
</body>

</html>