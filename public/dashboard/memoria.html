<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraFlow - Sistema de Monitoramento</title>
    <link rel="stylesheet" href="../css/memoria.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <div class="layout">

        <aside class="sidebar">

            <nav class="nav">
                <button data-view="overview" class="nav-item active">
                    <i class="fas fa-gauge"></i>
                    <span>Painel</span>
                </button>
                <button data-view="monitor" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Monitoramento</span>
                </button>
                <button data-view="especificacao" class="nav-item">
                    <i class="fas fa-cogs"></i>
                    <span>Especificação Técnica</span>
                </button>
                <button data-view="historico" class="nav-item">
                    <i class="fas fa-clock-rotate-left"></i>
                    <span>Histórico de Alertas</span>
                </button>
            </nav>

            <div class="divider"></div>

            <div class="user-section">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="sidebarUser">Admin</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>


        <div class="main-area">
            <header class="topbar">

                <div class="brand">
                    <img src="../assets/infra-parafundobranco.png" alt="">
                </div>
                <div class="topbar-left">
                    <div class="machine-select">
                        <i class="fas fa-server"></i>
                        <label for="edgeSelector"
                            style="display:block; font-size:14px; margin-bottom:4px; color: gray;">
                            Selecione um pórtico FreeFlow:
                        </label>
                        <select id="edgeSelector">
                            <option value="1">INFRA-EDGE-01-Itápolis (SP-333)</option>
                            <option value="2">INFRA-EDGE-02-Jaboticabal (SP-333)</option>
                            <option value="3">INFRA-EDGE-03-São José dos Campos (SP-099)</option>
                            <option value="4">INFRA-EDGE-04-Itaguaí (Km 414)</option>
                        </select>
                    </div>
                    <div class="os-info">
                        <i class="fab fa-ubuntu"></i>
                        <span>Ubuntu 22.04 LTS</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                    <div class="last-update">
                        <span class="update-label">Última atualização:</span>
                        <span class="update-time" id="lastUpdateTime">--:--:--</span>
                    </div>
                </div>
            </header>


            <main class="content">

                <div class="view-content active" data-view-content="overview">
                    <div class="view-header">
                        <h1 class="view-title">
                            <i class="fas fa-memory"></i>
                            Painel de Monitoramento de Memória RAM
                        </h1>
                    </div>

                    <div class="kpis-grid">
                        <div class="kpi-card" id="kpiMemoriaUso">
                            <div class="kpi-header">
                                <div class="kpi-icon memoria">
                                    <i class="fas fa-percent"></i>
                                </div>
                                <div class="kpi-info">
                                    <span class="kpi-label">Uso de Memória RAM Atual</span>
                                </div>
                            </div>
                            <div class="kpi-value" id="kpiMemoriaUsoValue">0%</div>
                            <div class="kpi-progress">
                                <div class="progress-bar memoria" id="memoriaUsoProgress"></div>
                            </div>
                        </div>

                        <div class="kpi-card" id="kpiMemoriaLivre">
                            <div class="kpi-header">
                                <div class="kpi-icon memoria">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="kpi-info">
                                    <span class="kpi-label">Memória RAM Livre</span>
                                </div>
                            </div>
                            <div class="kpi-value" id="kpiMemoriaLivreValue">0 GB</div>
                            <div class="kpi-progress">
                                <div class="progress-bar memoria" id="memoriaLivreProgress"></div>
                            </div>
                        </div>

                        <div class="kpi-card" id="kpiMemoriaTotal">
                            <div class="kpi-header">
                                <div class="kpi-icon memoria">
                                    <i class="fas fa-microchip"></i>
                                </div>
                                <div class="kpi-info">
                                    <span class="kpi-label">Memória RAM Total</span>
                                </div>
                            </div>
                            <div class="kpi-value" id="kpiMemoriaTotalValue">0 GB</div>
                            <div class="kpi-progress">
                                <div class="progress-bar memoria" id="memoriaTotalProgress"></div>
                            </div>
                        </div>

                        <div class="kpi-card" id="kpiMemoriaAlerta">
                            <div class="kpi-header">
                                <div class="kpi-icon memoria">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="kpi-info">
                                    <span class="kpi-label">Alertas Críticos (Última Hora)</span>
                                </div>
                            </div>
                            <div class="kpi-value kpi-alert" id="kpiMemoriaAlertaValue">0</div>
                            <div class="kpi-progress">
                                <div class="progress-bar memoria" id="memoriaAlertaProgress" style="width: 0%;"></div>
                            </div>
                        </div>

                    </div>

                        <div class="status-and-legend">
                            <div class="legend-card">
                                <h3 class="legend-title"><i class="fas fa-circle-info"></i> Parâmetros de Alerta</h3>
                                <table class="legend-table">
                                    <thead>
                                        <tr>
                                            <th>Componente</th>
                                            <th>Utilização saudável</th>
                                            <th>Alta utilização <small>(monitorar)*</small></th>
                                            <th>Saturação <small>(crítico)</small></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Memória RAM (%)</td>
                                            <td>40% – 53%</td>
                                            <td><span class="pill warn">54% – 83%</span></td>
                                            <td><span class="pill crit">&gt; 84%</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    <div class="charts">
                        <div class="chart-box">
                            <h3><i class="fas fa-chart-line"></i> Últimos Dados de Utilização</h3>
                            <canvas id="grafico_memoria_uso"></canvas>
                        </div>
                        <div class="chart-box">
                            <h3><i class="fas fa-chart-pie"></i> Memória Livre vs. Utilizada (Tempo Real)</h3>
                            <canvas id="grafico_memoria_status"></canvas>
                        </div>
                    </div>

                </div>

                <div class="view-content hidden" data-view-content="monitor">
                    <div class="view-header">
                        <h1 class="view-title">
                            <i class="fas fa-chart-line"></i> Monitoramento (Histórico de Registros)
                        </h1>
                    </div>
                    <div class="table-section">
                        <div class="table-header">
                            <h3 class="table-title">
                                <i class="fas fa-table"></i> Últimas Leituras
                            </h3>
                            <div class="table-actions">
                                <button id="exportMonitorCsv" class="btn btn-export">
                                    <i class="fas fa-download"></i> Exportar CSV
                                </button>
                            </div>
                        </div>
                        <div class="table-container monitor-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-server"></i> Pórtico</th>
                                        <th><i class="fas fa-percent"></i> Uso RAM (%)</th>
                                        <th><i class="fas fa-check-circle"></i> RAM Livre (GB)</th>
                                        <th><i class="fas fa-microchip"></i> RAM Total (GB)</th>
                                        <th><i class="fas fa-clock"></i> Horário</th>
                                    </tr>
                                </thead>
                                <tbody id="monitorTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="view-content hidden" data-view-content="especificacao">
    <div class="view-header">
        <h1 class="view-title">
            <i class="fas fa-cogs"></i>
            Especificação Técnica - Pórticos FreeFlow
        </h1>
    </div>

    <div class="specs-grid">
        <div class="specs-card">
            <div class="specs-header">
                <i class="fas fa-microchip"></i>
                <h3>Hardware - Controlador de Pórtico</h3>
            </div>
            <div class="specs-content">
                <div class="spec-item">
                    <span class="spec-label">Processador:</span>
                    <span class="spec-value">Intel Xeon E-2336 (6 cores, 12 threads)</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Memória RAM:</span>
                    <span class="spec-value">32GB DDR4 ECC 3200MHz</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Armazenamento:</span>
                    <span class="spec-value">SSD NVMe 1TB + HDD 4TB</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Rede:</span>
                    <span class="spec-value">Dual 10GbE SFP+ + Quad Gigabit</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Conectividade:</span>
                    <span class="spec-value">4G/LTE + Wi-Fi 6 + GPS RTK</span>
                </div>
            </div>
        </div>

        <div class="specs-card">
            <div class="specs-header">
                <i class="fas fa-satellite-dish"></i>
                <h3>Sensores & Dispositivos</h3>
            </div>
            <div class="specs-content">
                <div class="spec-item">
                    <span class="spec-label">Câmeras ANPR:</span>
                    <span class="spec-value">8MP com IR @ 60fps</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">RFID/DSRC:</span>
                    <span class="spec-value">Antenas 5.8GHz DSRC</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Sensores:</span>
                    <span class="spec-value">LiDAR + Loops Indutivos</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Processamento IA:</span>
                    <span class="spec-value">NVIDIA Jetson Orin</span>
                </div>
            </div>
        </div>

        <div class="specs-card">
            <div class="specs-header">
                <i class="fas fa-desktop"></i>
                <h3>Software & Sistemas</h3>
            </div>
            <div class="specs-content">
                <div class="spec-item">
                    <span class="spec-label">Sistema Operacional:</span>
                    <span class="spec-value">Ubuntu Server 22.04 LTS</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Containerização:</span>
                    <span class="spec-value">Docker + Kubernetes</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Banco de Dados:</span>
                    <span class="spec-value">PostgreSQL + Redis</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Monitoramento:</span>
                    <span class="spec-value">Prometheus + Grafana</span>
                </div>
            </div>
        </div>

        <div class="specs-card">
            <div class="specs-header">
                <i class="fas fa-chart-bar"></i>
                <h3>Performance</h3>
            </div>
            <div class="specs-content">
                <div class="spec-item">
                    <span class="spec-label">Veículos/Hora:</span>
                    <span class="spec-value">Até 4.000 por faixa</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Reconhecimento:</span>
                    <span class="spec-value">&lt; 80ms por placa</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Uptime:</span>
                    <span class="spec-value">99.99% (52min/ano)</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">Temperatura:</span>
                    <span class="spec-value">-25°C a 55°C</span>
                </div>
            </div>
        </div>

        <div class="specs-card full-width">
            <div class="specs-header">
                <i class="fas fa-memory"></i>
                <h3>Gestão de Memória RAM</h3>
            </div>
            <div class="specs-content">
                <div class="memory-usage-info">
                    <div class="usage-category">
                        <h4>Alocação de Memória:</h4>
                        <ul>
                            <li><strong>Motor ANPR/OCR:</strong> 8-10GB - Processamento com IA</li>
                            <li><strong>Banco em Memória:</strong> 6-8GB - Cache de transações</li>
                            <li><strong>Buffer de Vídeo:</strong> 4-6GB - Frames HD</li>
                            <li><strong>Serviços DSRC:</strong> 2-3GB - Comunicação</li>
                            <li><strong>Sistema Operacional:</strong> 3-4GB - Kernel RT</li>
                        </ul>
                    </div>
                    <div class="usage-category">
                        <h4>Otimizações:</h4>
                        <ul>
                            <li><strong>Alocação Dinâmica:</strong> Ajuste por fluxo veicular</li>
                            <li><strong>Cache Inteligente:</strong> 2GB para placas frequentes</li>
                            <li><strong>Compressão LZ4:</strong> 70% redução em buffers</li>
                            <li><strong>Swap Otimizado:</strong> ZRAM + SSD NVMe</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                <div class="view-content hidden" data-view-content="historico">
                    <div class="view-header">
                        <h1 class="view-title">
                            <i class="fas fa-clock-rotate-left"></i>
                            Histórico de Alertas de Memória RAM
                        </h1>
                    </div>
                    <div class="table-section">
                        <div class="table-header">
                            <h3 class="table-title">
                                <i class="fas fa-list-check"></i> Alertas de Saturação (Crítico)
                            </h3>
                            <div class="table-actions">
                                <button id="exportHistoricoCsv" class="btn btn-export">
                                    <i class="fas fa-download"></i> Exportar CSV
                                </button>
                            </div>
                        </div>
                        <div class="table-container historico-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-server"></i> Pórtico</th>
                                        <th><i class="fas fa-bell"></i> Alerta</th>
                                        <th><i class="fas fa-percent"></i> Uso RAM (%)</th>
                                        <th><i class="fas fa-calendar"></i> Data e Hora</th>
                                        <th><i class="fas fa-clipboard-list"></i> Ação Tomada</th>
                                    </tr>
                                </thead>
                                <tbody id="historicoTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
    let ID_MAQUINA = 1;
    let updateInterval;
    let graficoMemoriaUso, graficoMemoriaStatus;

    const elements = {
        kpiMemoriaUsoValue: document.getElementById('kpiMemoriaUsoValue'),
        memoriaUsoProgress: document.getElementById('memoriaUsoProgress'),
        kpiMemoriaLivreValue: document.getElementById('kpiMemoriaLivreValue'),
        memoriaLivreProgress: document.getElementById('memoriaLivreProgress'),
        kpiMemoriaTotalValue: document.getElementById('kpiMemoriaTotalValue'),
        memoriaTotalProgress: document.getElementById('memoriaTotalProgress'),
        kpiMemoriaAlertaValue: document.getElementById('kpiMemoriaAlertaValue'),
        memoriaAlertaProgress: document.getElementById('memoriaAlertaProgress'),
        lastUpdateTime: document.getElementById('lastUpdateTime'),
        monitorTableBody: document.getElementById('monitorTableBody'),
        historicoTableBody: document.getElementById('historicoTableBody'),
        edgeSelector: document.getElementById('edgeSelector')
    };

    function inicializarGraficos() {
        const ctxLinha = document.getElementById('grafico_memoria_uso').getContext('2d');
        graficoMemoriaUso = new Chart(ctxLinha, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Uso de Memória RAM (%)',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#10b981',
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Uso (%)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        const ctxStatus = document.getElementById('grafico_memoria_status').getContext('2d');
        graficoMemoriaStatus = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Utilizada', 'Livre'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#059669', '#d1fae5'],
                    borderColor: 'white',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.label}: ${context.parsed}%`;
                            }
                        }
                    }
                },
                cutout: '75%',
            }
        });
    }

    function configurarNavegacao() {
        document.querySelectorAll('.sidebar .nav-item').forEach(button => {
            button.addEventListener('click', () => {
                const viewName = button.getAttribute('data-view');

                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.view-content').forEach(view => {
                    view.classList.add('hidden');
                });

                const selectedView = document.querySelector(`[data-view-content="${viewName}"]`);
                if (selectedView) {
                    selectedView.classList.remove('hidden');

                    switch (viewName) {
                        case 'overview':
                            carregarDadosOverview();
                            break;
                        case 'monitor':
                            carregarDadosMonitor();
                            break;
                        case 'historico':
                            carregarAlertasHistorico();
                            break;
                    }
                }
            });
        });
    }

    async function carregarDadosOverview() {
        try {
            console.log('Carregando dados overview para máquina', ID_MAQUINA);
            const response = await fetch(`/api/memoria/detalhes/${ID_MAQUINA}`);
           
            if (!response.ok) {
                if (response.status === 404) {
                    console.warn('Dados não encontrados para máquina', ID_MAQUINA);
                    elements.kpiMemoriaUsoValue.textContent = 'N/D';
                    elements.kpiMemoriaLivreValue.textContent = 'N/D';
                    elements.kpiMemoriaTotalValue.textContent = '32 GB';
                    return;
                }
                throw new Error('Erro na resposta da API: ' + response.status);
            }
           
            const dados = await response.json();
           
            if (dados.error) {
                console.error('Erro nos dados:', dados.error);
                elements.kpiMemoriaUsoValue.textContent = 'Erro';
                return;
            }

            console.log('Dados recebidos:', dados);
            atualizarKPIs(dados);
            atualizarGraficos(dados);
            atualizarUltimaAtualizacao();
           
        } catch (error) {
            console.error('Erro ao carregar dados overview:', error);
            elements.kpiMemoriaUsoValue.textContent = 'Erro';
        }
    }

    async function carregarDadosMonitor() {
        try {
            const response = await fetch(`/api/memoria/historico/${ID_MAQUINA}?limite=50`);
           
            if (!response.ok) {
                if (response.status === 404) {
                    elements.monitorTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum dado histórico disponível</td></tr>';
                    return;
                }
                throw new Error('Erro na resposta da API');
            }
           
            const dados = await response.json();
           
            if (dados.error) {
                elements.monitorTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">${dados.error}</td></tr>`;
                return;
            }

            if (dados.length > 0) {
                atualizarTabelaMonitor(dados);
            } else {
                elements.monitorTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum dado encontrado</td></tr>';
            }
           
        } catch (error) {
            console.error('Erro ao carregar dados do monitor:', error);
            elements.monitorTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar dados</td></tr>';
        }
    }

    async function carregarAlertasHistorico() {
        try {
            console.log(`Carregando alertas para máquina ${ID_MAQUINA}`);
           
            const response = await fetch(`/api/memoria/alertas/${ID_MAQUINA}?horas=24`);
           
            if (!response.ok) {
                console.error(`Erro na resposta: ${response.status}`);
               
                if (response.status === 404) {
                    elements.historicoTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum alerta encontrado nas últimas 24 horas</td></tr>';
                    elements.kpiMemoriaAlertaValue.textContent = '0';
                    elements.memoriaAlertaProgress.style.width = '0%';
                    return;
                }
                throw new Error('Erro na resposta da API');
            }
           
            const alertas = await response.json();
            console.log(`Alertas recebidos:`, alertas);
           
            if (alertas.error) {
                console.error('Erro nos dados:', alertas.error);
                elements.historicoTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">${alertas.error}</td></tr>`;
                elements.kpiMemoriaAlertaValue.textContent = '0';
                elements.memoriaAlertaProgress.style.width = '0%';
                return;
            }

            if (Array.isArray(alertas) && alertas.length > 0) {
                atualizarTabelaAlertas(alertas);
               
                const alertasCriticos = alertas.filter(a => a.uso_percent > 84).length;
                elements.kpiMemoriaAlertaValue.textContent = alertasCriticos;
                elements.memoriaAlertaProgress.style.width = `${Math.min(alertasCriticos * 10, 100)}%`;
               
                console.log(`Total de alertas: ${alertas.length}, Críticos: ${alertasCriticos}`);
            } else {
                elements.historicoTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum alerta encontrado - Sistema operando normalmente</td></tr>';
                elements.kpiMemoriaAlertaValue.textContent = '0';
                elements.memoriaAlertaProgress.style.width = '0%';
            }
        } catch (error) {
            console.error('Erro ao carregar alertas:', error);
            elements.historicoTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar alertas. Verifique o console.</td></tr>';
            elements.kpiMemoriaAlertaValue.textContent = '0';
            elements.memoriaAlertaProgress.style.width = '0%';
        }
}

    function atualizarKPIs(dados) {
        elements.kpiMemoriaUsoValue.textContent = `${dados.uso_percent.toFixed(1)}%`;
        elements.memoriaUsoProgress.style.width = `${dados.uso_percent}%`;

        elements.kpiMemoriaLivreValue.textContent = `${dados.livre_gb} GB`;
        elements.memoriaLivreProgress.style.width = `${(dados.livre_gb / dados.total_gb) * 100}%`;

        elements.kpiMemoriaTotalValue.textContent = `${dados.total_gb} GB`;
        elements.memoriaTotalProgress.style.width = '100%';

        atualizarCoresKPIs(dados.uso_percent);
    }

    function atualizarCoresKPIs(usoPercent) {
        const kpiUso = document.getElementById('kpiMemoriaUso');
        const progressBar = elements.memoriaUsoProgress;

        kpiUso.classList.remove('status-normal', 'status-warning', 'status-critical');
        progressBar.classList.remove('status-normal', 'status-warning', 'status-critical');

        if (usoPercent <= 53) {
            kpiUso.classList.add('status-normal');
            progressBar.classList.add('status-normal');
        } else if (usoPercent <= 83) {
            kpiUso.classList.add('status-warning');
            progressBar.classList.add('status-warning');
        } else {
            kpiUso.classList.add('status-critical');
            progressBar.classList.add('status-critical');
        }
    }

    function atualizarGraficos(dados) {
        graficoMemoriaStatus.data.datasets[0].data = [dados.uso_percent, 100 - dados.uso_percent];
        graficoMemoriaStatus.update('none');

        atualizarGraficoLinha();
    }

    async function atualizarGraficoLinha() {
        try {
            const response = await fetch(`/api/memoria/historico/${ID_MAQUINA}?limite=30`);
           
            if (!response.ok) {
                console.warn('Erro ao buscar histórico para gráfico');
                return;
            }
           
            const historico = await response.json();
           
            if (historico.error) {
                console.warn('Erro nos dados do histórico:', historico.error);
                return;
            }

            if (historico.length > 0) {
                const dadosUso = historico.map(item => item.uso_percent);
                const labels = historico.map(item =>
                    new Date(item.data_hora_captura).toLocaleTimeString('pt-BR')
                );
               
                graficoMemoriaUso.data.labels = labels;
                graficoMemoriaUso.data.datasets[0].data = dadosUso;
                graficoMemoriaUso.update('none');
                console.log('Gráfico de linha atualizado com', historico.length, 'pontos');
            }
        } catch (error) {
            console.error('Erro ao atualizar gráfico de linha:', error);
        }
    }

    function atualizarTabelaMonitor(dados) {
        const tbody = elements.monitorTableBody;
        tbody.innerHTML = '';

        const nomesMaquinas = {
            1: "INFRA-EDGE-01-Itápolis (SP-333)",
            2: "INFRA-EDGE-02-Jaboticabal (SP-333)",
            3: "INFRA-EDGE-03-São José dos Campos (SP-099)",
            4: "INFRA-EDGE-04-Itaguaí (Km 414)"
        };

        const dadosOrdenados = dados.sort((a, b) =>
            new Date(b.data_hora_captura) - new Date(a.data_hora_captura)
        );

        dadosOrdenados.forEach(item => {
            const nomeMaquina = nomesMaquinas[item.id_maquina] || `Máquina ${item.id_maquina}`;
           
            const row = `
            <tr>
                <td>${nomeMaquina}</td>
                <td>${item.uso_percent.toFixed(1)}%</td>
                <td>${item.memoria_livre_gb} GB</td>
                <td>${item.memoria_total_gb} GB</td>
                <td>${new Date(item.data_hora_captura).toLocaleString('pt-BR')}</td>
            </tr>
        `;
            tbody.innerHTML += row;
        });
    }

    function atualizarTabelaAlertas(alertas) {
    const tbody = elements.historicoTableBody;
    tbody.innerHTML = '';

    const nomesMaquinas = {
        1: "INFRA-EDGE-01-Itápolis (SP-333)",
        2: "INFRA-EDGE-02-Jaboticabal (SP-333)",
        3: "INFRA-EDGE-03-São José dos Campos (SP-099)",
        4: "INFRA-EDGE-04-Itaguaí (Km 414)"
    };

    // Ordenando os dados pela data mais recente
    const alertasOrdenados = alertas.sort((a, b) =>
        new Date(b.data_hora) - new Date(a.data_hora)
    );

    alertasOrdenados.forEach(alerta => {
        const nomeMaquina = alerta.nome_maquina ||
                           nomesMaquinas[ID_MAQUINA] ||
                           `Máquina ${ID_MAQUINA}`;

        const usoPercent = parseFloat(alerta.uso_percent) || 0;
        let nivelClasse = 'success';
        let acaoTexto = 'Normal';
       
        if (usoPercent > 84) {
            nivelClasse = 'crit';
            acaoTexto = 'Estado Crítico';
        } else if (usoPercent > 54) {
            nivelClasse = 'warn';
            acaoTexto = 'Monitorar';
        } else {
            nivelClasse = 'success';
            acaoTexto = 'Verificado';
        }

        // Formatar data
        const dataFormatada = new Date(alerta.data_hora).toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        const row = `
            <tr style="border-left: 4px solid ${nivelClasse === 'crit' ? '#ef4444' : nivelClasse === 'warn' ? '#f59e0b' : '#10b981'}">
                <td><strong>${nomeMaquina}</strong></td>
                <td>${alerta.descricao || 'Alerta de memória'}</td>
                <td><span class="pill ${nivelClasse}">${usoPercent.toFixed(1)}%</span></td>
                <td>${dataFormatada}</td>
                <td>
                    <span class="pill ${nivelClasse}">
                        ${acaoTexto}
                    </span>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    console.log(`Tabela atualizada com ${alertas.length} alertas`);
}

    function atualizarUltimaAtualizacao() {
        const now = new Date();
        elements.lastUpdateTime.textContent = now.toLocaleTimeString('pt-BR');
    }

    function iniciarAtualizacaoAutomatica() {
    console.log('Iniciando atualização dos daods que estão sendo inseridos no banco de dados');
    carregarDadosOverview();
    carregarAlertasHistorico();
    updateInterval = setInterval(() => {
        console.log('Atualizando dados...', new Date().toLocaleTimeString());
        carregarDadosOverview();
        const now = new Date();
        if (now.getSeconds() % 30 === 0) {
            carregarAlertasHistorico();
        }
    }, 2000);
    }

    function configurarEventos() {
        elements.edgeSelector.addEventListener('change', function () {
            ID_MAQUINA = this.value;
            carregarDadosOverview();
            if (document.querySelector('[data-view-content="monitor"]').classList.contains('hidden') === false) {
                carregarDadosMonitor();
            }
            if (document.querySelector('[data-view-content="historico"]').classList.contains('hidden') === false) {
                carregarAlertasHistorico();
            }
        });

        document.getElementById('exportMonitorCsv')?.addEventListener('click', exportarCSVMonitor);
        document.getElementById('exportHistoricoCsv')?.addEventListener('click', exportarCSVHistorico);
    }

    function exportarCSVMonitor() {
        const rows = [['Pórtico', 'Uso RAM (%)', 'RAM Livre (GB)', 'RAM Total (GB)', 'Horário']];
        const tableRows = elements.monitorTableBody.querySelectorAll('tr');
       
        tableRows.forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length === 5) {
                rows.push([
                    cols[0].textContent,
                    cols[1].textContent,
                    cols[2].textContent,
                    cols[3].textContent,
                    cols[4].textContent
                ]);
            }
        });

        const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "monitor_memoria.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportarCSVHistorico() {
        const rows = [['Pórtico', 'Alerta', 'Uso RAM (%)', 'Data e Hora', 'Ação Tomada']];
        const tableRows = elements.historicoTableBody.querySelectorAll('tr');
       
        tableRows.forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length === 5) {
                rows.push([
                    cols[0].textContent,
                    cols[1].textContent,    
                    cols[2].textContent,
                    cols[3].textContent,
                    cols[4].textContent
                ]);
            }
        });

        const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "historico_alertas_memoria.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function debugAlertas() {
        console.log('testando os endpoint dos alertas');
       
        try {
            const response = await fetch(`/api/memoria/alertas/${ID_MAQUINA}?horas=24`);
            const data = await response.json();
           
            console.log('Resposta da API:', {
                status: response.status,
                ok: response.ok,
                dados: data,
                quantidade: Array.isArray(data) ? data.length : 'não é array'
            });
           
            return data;
        } catch (error) {
            console.error('rro na parte debug:', error);
            return null;
        }
    }


    document.addEventListener('DOMContentLoaded', function () {
        inicializarGraficos();
        configurarNavegacao();
        configurarEventos();
        iniciarAtualizacaoAutomatica();
    });

    window.addEventListener('beforeunload', function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
</script>
</body>

</html>