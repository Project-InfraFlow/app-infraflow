<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraFlow - Sistema de Monitoramento</title>
    <link rel="stylesheet" href="../css/dashboards.css">
    <link rel="stylesheet" href="../css/memoria.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../assets/imgs/estrada.png">
</head>

<body>
    <div id="dashboard" class="dashboard">
        <aside class="sidebar">
            <nav class="nav">
                <button data-view="overview" class="nav-item active"><i
                        class="fas fa-gauge"></i><span>Painel</span></button>
                <button data-view="monitor" class="nav-item"><i
                        class="fas fa-chart-line"></i><span>Monitoramento</span></button>
                <button data-view="especificacao" class="nav-item"><i class="fas fa-cogs"></i><span>Especifica√ß√£o
                        T√©cnica</span></button>
                <button data-view="historico" class="nav-item"><i class="fas fa-clock-rotate-left"></i><span>Hist√≥rico
                        de Alertas</span></button>
            </nav>
            <div class="divider"></div>
            <div class="user-section">
                <div class="user-info"><i class="fas fa-user-circle"></i><span id="sidebarUser">Admin</span></div>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </aside>

        <main class="content">
            <header class="topbar">
                <div class="brand">
                    <a href="dashboard.html"><img src="../assets/infra-parafundobranco.png" alt="InfraFlow"></a>
                </div>
                <div class="topbar-left">
                    <div class="machine-select">
                        <i class="fas fa-server"></i>
                        <label for="edgeSelector">Selecione um p√≥rtico FreeFlow:</label>
                        <select id="edgeSelector">
                            <option value="1">INFRA-EDGE-01-It√°polis (SP-333)</option>
                        </select>
                    </div>
                    <div class="os-info"><i class="fab fa-ubuntu"></i><span>Ubuntu 22.04 LTS</span></div>
                </div>
                <div class="topbar-right">
                    <div class="status-indicator">
                        <div class="status-dot"></div><span>Online</span>
                    </div>
                    <div class="last-update">
                        <span class="update-label">√öltima atualiza√ß√£o:</span>
                        <span class="update-time" id="lastUpdateTime">--:--:--</span>
                    </div>
                </div>
            </header>

            <div class="view-content active" data-view-content="overview">
                <div class="view-header">
                    <h1 class="view-title"><i class="fas fa-memory"></i>Painel de Monitoramento de Mem√≥ria RAM</h1>
                </div>

                <div class="kpis-grid">
                    <div class="kpi-card" id="kpiMemoriaUso">
                        <div class="kpi-header">
                            <div class="kpi-icon memoria"><i class="fas fa-percent"></i></div>
                            <div class="kpi-info"><span class="kpi-label">Uso de Mem√≥ria RAM Atual</span></div>
                        </div>
                        <div class="kpi-value" id="kpiMemoriaUsoValue">0%</div>
                        <div class="kpi-progress">
                            <div class="progress-bar memoria" id="memoriaUsoProgress"></div>
                        </div>
                    </div>

                    <div class="kpi-card" id="kpiMemoriaLivre">
                        <div class="kpi-header">
                            <div class="kpi-icon memoria"><i class="fas fa-check-circle"></i></div>
                            <div class="kpi-info"><span class="kpi-label">Mem√≥ria RAM Livre</span></div>
                        </div>
                        <div class="kpi-value" id="kpiMemoriaLivreValue">0 GB</div>
                        <div class="kpi-progress">
                            <div class="progress-bar memoria" id="memoriaLivreProgress"></div>
                        </div>
                    </div>

                    <div class="kpi-card" id="kpiTotalProcessos">
                        <div class="kpi-header">
                            <div class="kpi-icon memoria">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Processos Ativos</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiTotalProcessosValue">0</div>
                        <div class="kpi-progress">
                            <div class="progress-bar memoria" id="totalProcessosProgress" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="kpi-card" id="kpiMemoriaAlerta">
                        <div class="kpi-header">
                            <div class="kpi-icon memoria"><i class="fas fa-bell"></i></div>
                            <div class="kpi-info"><span class="kpi-label">Alertas Cr√≠ticos (√öltima Hora)</span></div>
                        </div>
                        <div class="kpi-value kpi-alert" id="kpiMemoriaAlertaValue">0</div>
                        <div class="kpi-progress">
                            <div class="progress-bar memoria" id="memoriaAlertaProgress" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="status-and-legend">
                    <div class="legend-card">
                        <h3 class="legend-title"><i class="fas fa-circle-info"></i> Par√¢metros de Alerta</h3>
                        <table class="legend-table">
                            <thead>
                                <tr>
                                    <th>Componente</th>
                                    <th>Utiliza√ß√£o saud√°vel</th>
                                    <th>Alta utiliza√ß√£o <small>(monitorar)*</small></th>
                                    <th>Satura√ß√£o <small>(cr√≠tico)</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mem√≥ria RAM (%)</td>
                                    <td>40% ‚Äì 53%</td>
                                    <td><span class="pill warn">54% ‚Äì 83%</span></td>
                                    <td><span class="pill crit">&gt; 84%</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="charts">
                    <div class="chart-box">
                        <h3><i class="fas fa-chart-line"></i> √öltimos Dados de Utiliza√ß√£o</h3>
                        <canvas id="grafico_memoria_uso"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3><i class="fas fa-chart-pie"></i> Mem√≥ria Livre vs. Utilizada (Tempo Real)</h3>
                        <canvas id="grafico_memoria_status"></canvas>
                    </div>
                </div>
            </div>

            <div class="view-content hidden" data-view-content="monitor">
                <div class="view-header">
                    <h1 class="view-title"><i class="fas fa-chart-line"></i> Monitoramento (Hist√≥rico de Registros)</h1>
                </div>
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-table"></i> √öltimas Leituras</h3>
                        <div class="table-actions">
                            <button id="exportMonitorCsv" class="btn btn-export"><i class="fas fa-download"></i>
                                Exportar CSV</button>
                        </div>
                    </div>
                    <div class="table-container monitor-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-server"></i> P√≥rtico</th>
                                    <th><i class="fas fa-percent"></i> Uso RAM (%)</th>
                                    <th><i class="fas fa-check-circle"></i> RAM Livre (GB)</th>
                                    <th><i class="fas fa-microchip"></i> RAM Total (GB)</th>
                                    <th><i class="fas fa-clock"></i> Hor√°rio</th>
                                </tr>
                            </thead>
                            <tbody id="monitorTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="view-content hidden" data-view-content="historico">
                <div class="view-header">
                    <h1 class="view-title"><i class="fas fa-clock-rotate-left"></i>Hist√≥rico de Alertas de Mem√≥ria RAM
                    </h1>
                </div>
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-list-check"></i> Alertas de Satura√ß√£o (Cr√≠tico)</h3>
                        <div class="table-actions">
                            <button id="exportHistoricoCsv" class="btn btn-export"><i class="fas fa-download"></i>
                                Exportar CSV</button>
                        </div>
                    </div>
                    <div class="table-container historico-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-server"></i> P√≥rtico</th>
                                    <th><i class="fas fa-bell"></i> Alerta</th>
                                    <th><i class="fas fa-percent"></i> Uso RAM (%)</th>
                                    <th><i class="fas fa-calendar"></i> Data e Hora</th>
                                    <th><i class="fas fa-clipboard-list"></i> A√ß√£o Tomada</th>
                                </tr>
                            </thead>
                            <tbody id="historicoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let ID_MAQUINA = 1;
        let graficoMemoriaUso, graficoMemoriaStatus;
        let updateInterval;

        console.log('üöÄ Inicializando dashboard de mem√≥ria...');

        const apiService = {
            async get(url) {
                try {
                    const separator = url.includes('?') ? '&' : '?';
                    const response = await fetch(`${url}${separator}_=${Date.now()}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.status === 204 ? null : response.json();
                } catch (error) {
                    console.error('‚ùå Erro API:', error);
                    throw error;
                }
            }
        };

        function inicializarGraficos() {
            console.log('üìà Inicializando gr√°ficos...');

            // Gr√°fico de linha
            const ctxLinha = document.getElementById('grafico_memoria_uso');
            graficoMemoriaUso = new Chart(ctxLinha, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Uso de Mem√≥ria RAM (%)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Gr√°fico de pizza
            const ctxStatus = document.getElementById('grafico_memoria_status');
            graficoMemoriaStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Utilizada', 'Livre'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#059669', '#d1fae5'],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%'
                }
            });

            console.log('‚úÖ Gr√°ficos inicializados');
        }

        function configurarNavegacao() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                    btn.classList.add('active');
                    const view = document.querySelector(`[data-view-content="${btn.dataset.view}"]`);
                    if (view) {
                        view.classList.remove('hidden');
                        if (btn.dataset.view === 'overview') carregarDados();
                        else if (btn.dataset.view === 'monitor') carregarMonitor();
                        else if (btn.dataset.view === 'historico') carregarAlertas();
                    }
                });
            });
        }

        async function carregarDados() {
            try {
                console.log('üîÑ Buscando dados da API...');

                // Buscar dados principais de mem√≥ria
                const dados = await apiService.get(`/api/memoria/detalhes/${ID_MAQUINA}`);

                if (!dados) {
                    console.log('üì≠ Nenhum dado retornado');
                    return;
                }

                console.log('üìä Dados recebidos:', dados);

                const uso = parseFloat(dados.uso_percent) || 0;
                const livre = parseFloat(dados.livre_gb) || 0;
                const total = parseFloat(dados.total_gb) || 30;

                // 1. ATUALIZAR KPIS DE MEM√ìRIA
                const kpiUso = document.getElementById('kpiMemoriaUsoValue');
                const progressUso = document.getElementById('memoriaUsoProgress');
                const kpiLivre = document.getElementById('kpiMemoriaLivreValue');
                const progressLivre = document.getElementById('memoriaLivreProgress');

                if (kpiUso) kpiUso.textContent = `${uso.toFixed(1)}%`;
                if (progressUso) progressUso.style.width = `${Math.min(uso, 100)}%`;

                if (kpiLivre) kpiLivre.textContent = `${livre.toFixed(1)} GB`;
                if (progressLivre) progressLivre.style.width = `${Math.min((livre / total) * 100, 100)}%`;

                // 2. ATUALIZAR GR√ÅFICO DE PIZZA (Mem√≥ria Livre vs Utilizada)
                if (graficoMemoriaStatus) {
                    graficoMemoriaStatus.data.datasets[0].data = [uso, 100 - uso];
                    graficoMemoriaStatus.update('none');
                }

                // 3. ATUALIZAR GR√ÅFICO DE LINHA (√öltimos Dados de Utiliza√ß√£o)
                const historico = await apiService.get(`/api/memoria/historico/${ID_MAQUINA}?limite=30`);
                if (historico && historico.length > 0 && graficoMemoriaUso) {
                    const historicoOrdenado = historico.slice().reverse();

                    graficoMemoriaUso.data.labels = historicoOrdenado.map(h =>
                        new Date(h.data_hora_captura).toLocaleTimeString('pt-BR')
                    );
                    graficoMemoriaUso.data.datasets[0].data = historicoOrdenado.map(h =>
                        parseFloat(h.uso_percent) || 0
                    );
                    graficoMemoriaUso.update('none');

                    console.log('‚úÖ Gr√°fico linha atualizado com', historicoOrdenado.length, 'pontos');
                }

                // 4. CARREGAR SOMA DE ALERTAS (√öltima Hora)
                try {
                    const alertas = await apiService.get(`/api/memoria/soma-alertas/${ID_MAQUINA}?horas=1`);
                    const totalAlertas = alertas?.total || 0;

                    const kpiAlerta = document.getElementById('kpiMemoriaAlertaValue');
                    const progressAlerta = document.getElementById('memoriaAlertaProgress');

                    if (kpiAlerta) kpiAlerta.textContent = totalAlertas;
                    if (progressAlerta) progressAlerta.style.width = `${Math.min(totalAlertas * 10, 100)}%`;

                    console.log('üö® Alertas totais (1h):', totalAlertas);
                } catch (alertError) {
                    console.error('‚ùå Erro ao carregar alertas:', alertError);
                }

                // 5. CARREGAR QUANTIDADE DE PROCESSOS
                try {
                    const processos = await apiService.get(`/api/memoria/total-processos/${ID_MAQUINA}`);
                    const totalProcessos = processos?.total || 0;
                    console.log('üñ•Ô∏è Total processos:', totalProcessos);

                    // ATUALIZAR A KPI DE PROCESSOS
                    document.getElementById('kpiTotalProcessosValue').textContent = totalProcessos;

                } catch (processosError) {
                    console.error('‚ùå Erro ao carregar processos:', processosError);
                }

                // 6. ATUALIZAR TIMESTAMP
                const agora = new Date();
                const lastUpdate = document.getElementById('lastUpdateTime');
                if (lastUpdate) lastUpdate.textContent = agora.toLocaleTimeString('pt-BR');

                console.log('‚úÖ Dashboard completamente atualizado:', {
                    uso: `${uso.toFixed(1)}%`,
                    livre: `${livre.toFixed(1)} GB`,
                    total: `${total} GB`,
                    horario: agora.toLocaleTimeString()
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
            }
        }

        async function carregarMonitor() {
            try {
                const dados = await apiService.get(`/api/memoria/historico/${ID_MAQUINA}?limite=50`);
                const tbody = document.getElementById('monitorTableBody');
                tbody.innerHTML = dados && dados.length > 0 ? dados.map(item => `
                <tr>
                    <td><strong>INFRA-EDGE-01-It√°polis (SP-333)</strong></td>
                    <td>${(parseFloat(item.uso_percent) || 0).toFixed(1)}%</td>
                    <td>${(parseFloat(item.livre_gb) || 0).toFixed(1)} GB</td>
                    <td>${parseFloat(item.total_gb) || 30} GB</td>
                    <td>${new Date(item.data_hora_captura).toLocaleString('pt-BR')}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" style="text-align: center;">Nenhum dado encontrado</td></tr>';
            } catch (error) {
                document.getElementById('monitorTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Erro ao carregar dados</td></tr>';
            }
        }

        async function carregarAlertas() {
            try {
                const alertas = await apiService.get(`/api/memoria/alertas/${ID_MAQUINA}?horas=1`);
                const tbody = document.getElementById('historicoTableBody');
                const criticos = alertas ? alertas.filter(a => (parseFloat(a.uso_percent) || 0) > 84).length : 0;

                document.getElementById('kpiMemoriaAlertaValue').textContent = criticos;
                document.getElementById('memoriaAlertaProgress').style.width = `${Math.min(criticos * 10, 100)}%`;

                tbody.innerHTML = alertas && alertas.length > 0 ? alertas.map(alerta => {
                    const uso = parseFloat(alerta.uso_percent) || 0;
                    const nivel = uso > 84 ? 'crit' : uso > 54 ? 'warn' : 'success';
                    const acao = uso > 84 ? 'Estado Cr√≠tico' : uso > 54 ? 'Monitorar' : 'Normal';
                    const cor = uso > 84 ? '#ef4444' : uso > 54 ? '#f59e0b' : '#10b981';
                    return `
                <tr style="border-left: 4px solid ${cor}">
                    <td><strong>INFRA-EDGE-01-It√°polis (SP-333)</strong></td>
                    <td>${alerta.descricao || 'Alerta de mem√≥ria'}</td>
                    <td><span class="pill ${nivel}">${uso.toFixed(1)}%</span></td>
                    <td>${new Date(alerta.data_hora).toLocaleString('pt-BR')}</td>
                    <td><span class="pill ${nivel}">${acao}</span></td>
                </tr>`;
                }).join('') : '<tr><td colspan="5" style="text-align: center; color: #10b981;">Nenhum alerta encontrado</td></tr>';
            } catch (error) {
                document.getElementById('historicoTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Erro ao carregar alertas</td></tr>';
            }
        }

        function iniciarAtualizacaoAutomatica() {
            console.log('‚è±Ô∏è Iniciando atualiza√ß√£o autom√°tica (5 segundos)');
            carregarDados();
            updateInterval = setInterval(() => {
                carregarDados();
            }, 5000);
        }

        async function carregarProcessos() {
            try {
                const processos = await apiService.get(`/api/memoria/total-processos/${ID_MAQUINA}`);
                const total = processos?.total || 0;
                console.log('üñ•Ô∏è Total processos:', total);
                // Aqui voc√™ pode atualizar uma KPI de processos se quiser
                return total;
            } catch (error) {
                console.error('‚ùå Erro ao carregar processos:', error);
                return 0;
            }
        }

        async function carregarSomaAlertas() {
            try {
                const alertas = await apiService.get(`/api/memoria/soma-alertas/${ID_MAQUINA}?horas=1`);
                const total = alertas?.total || 0;
                console.log('üö® Soma total alertas (1h):', total);

                // Atualizar a KPI de alertas
                const kpiAlerta = document.getElementById('kpiMemoriaAlertaValue');
                const progressAlerta = document.getElementById('memoriaAlertaProgress');

                if (kpiAlerta) kpiAlerta.textContent = total;
                if (progressAlerta) progressAlerta.style.width = `${Math.min(total * 10, 100)}%`;

                return total;
            } catch (error) {
                console.error('‚ùå Erro ao carregar soma de alertas:', error);
                return 0;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM carregado, inicializando...');

            inicializarGraficos();
            configurarNavegacao();
            iniciarAtualizacaoAutomatica();

            document.getElementById('edgeSelector').addEventListener('change', (e) => {
                ID_MAQUINA = parseInt(e.target.value);
                console.log('üñ•Ô∏è M√°quina alterada para:', ID_MAQUINA);
                carregarDados();
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Deseja realmente sair?')) {
                    window.location.href = '../index.html';
                }
            });

            console.log('üéØ Dashboard pronto e funcionando!');
        });

        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
                console.log('üßπ Intervalo limpo');
            }
        });
    </script>
</body>

</html>