<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraFlow - Sistema de Monitoramento</title>
    <link rel="stylesheet" href="../css/dashboard_alerta.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../assets/imgs/estrada.png">
</head>


<body onload="iniciar()">

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <aside class="sidebar">

            <nav class="nav">
                <button data-view="overview" class="nav-item">
                    <a href="dashboard.html">
                        <i class="fas fa-gauge"></i>
                        <span>Painel</span>
                    </a>

                </button>
                <button data-view="monitor" class="nav-item">
                    <a href="dashboard.html#monitor">
                        <i class="fas fa-chart-line"></i>
                        <span>Monitoramento</span>
                    </a>

                </button>
                <button data-view="cadastro" class="nav-item">
                    <a href="dashboard.html#cadastro"></a>
                    <i class="fas fa-pen-to-square"></i>
                    <span>Cadastro</span>
                </button>
                <a href="dashboard_alerta.html" class="nav-item active" style="text-decoration: none;">
                    <i class="fas fa-clock-rotate-left"></i>
                    <span>Hist√≥rico de Alertas</span>
                </a>
            </nav>

            <div class="divider"></div>

            <div class="user-section">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="sidebarUser">Admin</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Topbar -->
            <header class="topbar">

                <div class="brand">
                    <a href="dashboard.html" title="Voltar para o painel principal">
                        <img src="../assets/infra-parafundobranco.png" alt="InfraFlow">
                    </a>
                </div>
                <div class="topbar-left">
                    <div class="machine-select">
                        <i class="fas fa-server"></i>
                        <label for="edgeSelector"
                            style="display:block; font-size:14px; margin-bottom:4px; color: gray;">
                            Selecione um p√≥rtico FreeFlow:
                        </label>
                        <select id="edgeSelector">
                            <option value="INFRA-EDGE-01-It√°polis (SP-333)">INFRA-EDGE-01-It√°polis (SP-333)</option>

                        </select>
                    </div>
                    <div class="os-info">
                        <i class="fab fa-ubuntu"></i>
                        <span>Ubuntu 22.04 LTS</span>
                    </div>
                </div>

                <div class="topbar-right">
                    <div class="security-indicator">
                        <a href="seguranca.html" class="nocsec-link" title="NOC/SOC - Centro de Seguran√ßa">
                            <i class="fas fa-shield-alt"></i>
                            <span>NOC/SOC</span>
                        </a>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                    <div class="last-update">
                        <span class="update-label">√öltima atualiza√ß√£o:</span>
                        <span class="update-time" id="lastUpdateTime">--:--:--</span>
                    </div>
                </div>



            </header>

            <!-- Vis√£o Geral -->
            <section id="view-overview" class="view active">
                <div class="view-header">
                    <h1 class="view-title">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Vis√£o anal√≠tica de alertas <span id="monitor-selecionado"></span>
                    </h1>
                </div>




                <div class="kpis-grid">
                    <div class="kpi-card" id="kpiCpu">
                        <div class="kpi-header">
                            <div class="kpi-icon cpu">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Quantidade de alertas (Geral) <div class="tooltip-icon">
                                        <i class="bi bi-info-circle-fill"></i>
                                        <span class="tooltip-text">
                                            Esse indicador sinaliza a quantidade total de alertas de todos os
                                            componentes, que foram sinalizados no p√≥rtico nas √∫ltimas 24 horas.
                                        </span>
                                    </div></span>

                            </div>
                        </div>
                        <div class="kpi-value" id="total-alertas">
                        </div>


                    </div>

                    <div class="kpi-card" id="kpiDisco">
                        <div class="kpi-header">
                            <div class="kpi-info">
                                <span class="kpi-label">Tipos dos alertas
                                    <div class="tooltip-icon">
                                        <i class="bi bi-info-circle-fill"></i>
                                        <span class="tooltip-text">
                                            Este indicador sinaliza os a quantidade de alertas dividos por situa√ß√£o, de
                                            aten√ß√£o e crit√≠ca.
                                        </span>
                                    </div>
                                </span>
                            </div>
                        </div>

                        <div class="tipo-alerta atencao" style="background-color: rgb(247, 226, 0);">
                            <div id="qtd_atencao"></div>
                            <div>
                                <p>Aten√ß√£o</p>
                            </div>
                        </div>
                        <div class="tipo-alerta critico" style="background-color: rgb(152, 0, 0)">
                            <div id="qtd_critico"></div>
                            <div>
                                <p style="color: white;">Crit√≠co</p>
                            </div>
                        </div>


                    </div>

                    <div class="kpi-card" id="kpiAlertasPoisson">
                        <div class="kpi-header">
                            <div class="kpi-icon disco">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Alertas fora da curva
                                    <div class="tooltip-icon">
                                        <i class="bi bi-info-circle-fill"></i>
                                        <span class="tooltip-text">
                                            Este indicador nos permite observar o nivel da quantidade de
                                            alertas que ocorreram nas √∫ltimas 24 horas, com isso podemos entender se a
                                            situa√ß√£o est√° em uma opera√ß√£o comum ou n√£o.
                                        </span>
                                    </div>
                                </span>
                            </div>
                        </div>

                        <div class="kpi-value" id="kpialertapoisson"></div>
                        <div class="kpi-desc" id="kpidescpoisson"></div>
                    </div>

                    <div class="kpi-card" id="kpiRede">
                        <div class="kpi-header">
                            <div class="kpi-icon rede">
                                <i class="bi bi-card-checklist"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Alertas sem registro

                                    <div class="tooltip-icon">
                                        <i class="bi bi-info-circle-fill"></i>
                                        <span class="tooltip-text">
                                            Este indicador nos mostra quantos alertas ainda est√£o sem nenhum registro.
                                        </span>
                                    </div>



                                </span>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiRedeValue"></div>

                        <button class="btn_registros" onclick="abrirModalRegistros()">Registros</button>

                    </div>
                </div>


                <div class="charts-grid">
                    <div class="chart-container full-bleed">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="bi bi-calendar3"></i>
                                Distribui√ß√£o de alertas por Hora x Componente
                            </h3>
                            <!-- √çcone com tooltip -->
                            <div class="tooltip-icon">
                                <i class="bi bi-info-circle-fill"></i>
                                <span class="tooltip-text">
                                    Heatmap com o intuito de mostrar a atividade dos alertas por componente nas √∫ltimas
                                    24 horas. <br>

                                    ‚óªÔ∏è = 0 a 1 alertas (baixo) <br>

                                    üü® = 2 a 4 alertas (m√©dio) <br>

                                    üüß = 5 a 8 alertas (alto) <br>

                                    üü• = 9+ alertas (pico)
                                </span>
                            </div>
                        </div>
                        <div class="chart-content">
                            <div id="heatmap-chart"></div>
                        </div>
                    </div>
                </div>

                <div class="other-things">
                    <div class="componentes-grid">
                        <div class="chart-container-componentes full-bleed">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="bi bi-cpu-fill"></i>
                                    Alertas por componentes
                                </h3>
                                <div class="tooltip-icon">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <span class="tooltip-text">
                                        Este gr√°fico indica a quantidade de alertas por componente.
                                    </span>
                                </div>
                            </div>
                            <div class="chart-content-componente">
                                <div id="componentes-chart"></div>
                            </div>
                        </div>
                    </div>



                    <div class="alertas-list-grid">

                        <div class="conteudo ocorrencias-box" id="ocorrenciasBox">

                            <div class="ocorrencias-header">
                                <h3 class="chart-title">
                                    <i class="bi bi-clipboard-data-fill"></i>
                                    Ocorr√™ncias
                                </h3>

                                <div class="ocorrencias-actions">
                                    <button class="btn-exportar" id="btnExportarCSV" onclick="exportarCSV()">Exportar CSV</button>
                                </div>
                            </div>

                            <!-- CABE√áALHO DAS COLUNAS ‚Äî ADICIONADO -->
                            <div class="ocorrencias-head">
                                <div>P√≥rtico</div>
                                <div>Per√≠odo</div>
                                <div>Componente</div>
                                <div>M√©trica Reg.</div>
                                <div>Tipo</div>
                                <div>A√ß√£o/Laudo</div>
                            </div>

                            <div class="list-ocorrencias" id="listaOcorrencias">


                            </div>

                        </div>

                    </div>

                </div>
        </main>
    </div>

    <div id="modalOcorrencia" class="modal-ocorrencia hidden">
        <div class="modal-content">
            <h3>Registrar Ocorr√™ncia</h3>

            <textarea id="descricaoOcorrencia" placeholder="Descreva o que ocasionou o alerta..."
                class="textarea_modal"></textarea>

            <div class="modal-actions">
                <button onclick="fecharModal()" class="btn-cancelar">Cancelar</button>
                <button onclick="salvarOcorrencia()" class="btn-salvar">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalRegistrosAlertas" class="modal-registros">
        <div class="modal-content-registros">
           <button class="fecharModalRegistros" onclick="fecharModalRegistros()">&times;</button>

            <h2>Alertas com Registro</h2>
            <div id="listaRegistrosAlertas"></div>
        </div>
    </div>


</body>
</html>


<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="../js/alertas.js"></script>

<script>

    function criarBotaoSuporteJira() {
        const linkBotao = document.createElement('a');
        linkBotao.innerHTML = `
      <img src="../assets/icon/iconeJira.png" alt="√çcone de Suporte" width="24" height="24" />
      Suporte
    `;
        linkBotao.title = "Acessar o Help Desk do Jira";
        linkBotao.href = "https://infraflow-sptech.atlassian.net/servicedesk/customer/portal/2";
        linkBotao.target = "_blank";
        linkBotao.style.cssText = `
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      margin: 0;
      padding: 12px 24px;
      border-radius: 50px;
      border: none;
      text-decoration: none;
      background-color: #0052CC;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      font-weight: 600;
      font-size: 16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    `;

        linkBotao.onmouseover = function () {
            linkBotao.style.backgroundColor = '#0065FF';
            linkBotao.style.boxShadow = '0 6px 16px rgba(0, 0, 0, 0.3)';
        };
        linkBotao.onmouseout = function () {
            linkBotao.style.backgroundColor = '#0052CC';
            linkBotao.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.25)';
            linkBotao.style.transform = 'scale(1)';
        };

        linkBotao.onmousedown = function () {
            linkBotao.style.transform = 'scale(0.98)';
        };

        linkBotao.onmouseup = function () {
            linkBotao.style.transform = 'scale(1)';
        };

        document.body.appendChild(linkBotao);
    }




    const box = document.getElementById("ocorrenciasBox");
    const btnVerMais = document.getElementById("btnVerMais");
    const btnCSV = document.getElementById("btnExportarCSV");

    btnVerMais.addEventListener("click", () => {
        box.classList.toggle("expandido");

        btnVerMais.textContent =
            box.classList.contains("expandido")
                ? "Ver menos"
                : "Ver mais";
    });


    btnCSV.addEventListener("click", () => {
        const rows = [
            ["P√≥rtico", "Data", "Hor√°rio", "Componente", "M√©trica", "Tipo"],
            ["SSP-001", "17/11/2025", "12:29 ‚Äì 13:29", "CPU", "85%", "Cr√≠tico"],
            ["SSP-001", "17/11/2025", "12:29 ‚Äì 13:29", "RAM", "34%", "Aten√ß√£o"],
        ];

        let csv = "";
        rows.forEach(r => {
            csv += r.join(";") + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "ocorrencias.csv";
        a.click();
    });

    // tentando fun√ß√µes aquiiiiiii

    function kpiAlertasTotais() {
        fetch('/alertas-route/kpiAlertasTotais', {
            method: "GET"
        }).then(res => res.json())
            .then(function (resultado) {
                console.log("oiiiiii")
                var kpitotal = document.getElementById('total-alertas')
                var alertasTotais = resultado[0].alertasTotais
                kpitotal.innerHTML = `<div class="kpi-value" id="total-alertas"><p>${alertasTotais}</p></div>`

            })
    }

    function kpiAlertasPorTipo() {
        fetch('/alertas-route/kpiAlertasPorTipo', {
            method: "GET"
        }).then(res => res.json())

            .then(function (resultado) {

                console.log("foi? alertas p tipo")
                console.log(resultado)

                if (resultado && resultado.length > 0) {

                    const alertasAtencao = resultado[0].total_atencao;
                    const alertasCriticos = resultado[0].total_critico;

                    var kpiAtencao = document.getElementById('qtd_atencao');
                    if (kpiAtencao) {
                        kpiAtencao.innerHTML = `<div id="qtd_atencao">${alertasAtencao}</div>`;
                    }


                    var kpiCritico = document.getElementById('qtd_critico');
                    if (kpiCritico) {
                        kpiCritico.innerHTML = `<div id="qtd_critico" style="color: white;">${alertasCriticos}</div>`;
                    }


                } else {
                    console.warn("Nenhum resultado encontrado.");
                }

            })
            .catch(erro => {
                console.error("ERRO no fetch kpiAlertasPorTipo: ", erro);
            });
    }

    function carregarAlertasRecentes() {
        fetch("/alertas-route/listarAlertasRecentes")
            .then(res => res.status === 204 ? [] : res.json())
            .then(lista => {
                const div = document.getElementById("listaOcorrencias");
                div.innerHTML = ""; // limpa

                if (!lista || lista.length === 0) {
                    div.innerHTML = `<p style="text-align: center">Nenhum alerta encontrado.</p>`;
                    return;
                }

                lista.forEach(item => {
                    const data = new Date(item.dataHora);

                    const classe = item.tipo_alerta == 2
                        ? "critico"
                        : "atencao";

                    const html = `
                    <div class="ocorrencia-item ${classe}" style="margin-bottom: 2%;">
                        <div class="col">${item.portico}</div>

                        <div class="col">
                            ${data.toLocaleDateString("pt-BR")}<br>
                            <span class="sub">${data.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>

                        <div class="col">${item.componente}</div>
                        <div class="col">${item.valor}%</div>

                        <div class="col tipo">
                            ${classe === "critico" ? "Cr√≠tico" : "Aten√ß√£o"}
                        </div>

                        <div class="col acao">
                            <button class="btn-registrar"  onclick="abrirModalRegistrar(${item.id_alerta})">
                                Registrar <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    </div>
                `;

                    div.innerHTML += html;
                });
            })
            .catch(err => console.error("Erro ao carregar alertas:", err));
    }

    function salvarOcorrencia() {
        const descricao = document.getElementById("descricaoOcorrencia").value.trim();

        if (descricao.length < 3) {
            alert("Escreva uma descri√ß√£o v√°lida.");
            return;
        }

        fetch("/alertas-route/registrarOcorrencia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id_alerta: alertaSelecionado,
                descricao: descricao
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("Erro ao salvar");
                return res.text();
            })
            .then(msg => {
                console.log(msg);
                fecharModal();
                carregarAlertasRecentes();
            })
            .catch(err => console.error(err));
    }

    function kpiAlertasCriticos() {
        fetch('/alertas-route/kpiAlertasCriticos')
            .then(res => res.json())
            .then(data => {

                console.log("TESTE TESTE");

                document.getElementById("kpialertapoisson").textContent = data.alertasHoje;
                document.getElementById("kpidescpoisson").textContent = data.mensagem;

            })
            .catch(err => console.error("Erro no fetch KPI:", err));
    }

    function kpiAlertasSemRegistro() {
        fetch('/alertas-route/kpiAlertasSemRegistro')
            .then(res => res.json())
            .then(data => {

                console.log(data)

                const box = document.getElementById("kpiRedeValue");

                box.innerHTML = `
                <strong>${data.alertasSemRegistro}</strong><br>
                <span style="font-size: 14px; opacity: 0.8;">
                    ${data.mensagem}
                </span>
            `;
            })
            .catch(err => console.error("Erro no fetch KPI sem registro:", err));
    }

    function abrirModalRegistros() {

        fetch('/alertas-route/alertasComRegistroLista')
            .then(res => res.json())
            .then(lista => {

                const box = document.getElementById("listaRegistrosAlertas");
                box.innerHTML = "";

                if (lista.length === 0) {
                    box.innerHTML = "<p>Nenhum alerta possui registro.</p>";
                } else {
                    lista.forEach(item => {
                        box.innerHTML += `
                        <div class="alerta-item-registro">
                            <strong>ID:</strong> ${item.id_alerta}<br>
                            <strong>Componente:</strong> ${item.nome_componente}<br>
                            <strong>Valor:</strong> ${item.dados_float}<br>
                            <strong>Hora:</strong> ${item.data_hora_captura}<br>
                            <strong>Descri√ß√£o:</strong> ${item.descricao_alerta}
                            <br><br>
                        </div>
                    `;
                    });
                }

                document.getElementById("modalRegistrosAlertas").style.display = "block";
            })
            .catch(err => console.error("Erro ao buscar alertas com registro:", err));
    }



    function fecharModalRegistros() {
    document.getElementById("modalRegistrosAlertas").style.display = "none";
}

document.getElementById("btnExportarCSV").addEventListener("click", exportarCSV);

function exportarCSV() {

    fetch("/alertas-route/listarAlertasRecentes")
        .then(res => res.status === 204 ? [] : res.json())
        .then(lista => {

            if (!lista || lista.length === 0) {
                alert("Nenhum alerta para exportar.");
                return;
            }

            // Cabe√ßalho do CSV
            let csv = "P√≥rtico;Data;Hora;Componente;Valor (%);Tipo\n";

            lista.forEach(item => {
                const data = new Date(item.dataHora);

                const dataFormatada = data.toLocaleDateString("pt-BR");
                const horaFormatada = data.toLocaleTimeString("pt-BR", {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const tipo = item.tipo_alerta == 2 ? "Cr√≠tico" : "Aten√ß√£o";

                csv += `${item.portico};${dataFormatada};${horaFormatada};${item.componente};${item.valor};${tipo}\n`;
            });

            // Criar arquivo para download
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = `alertas_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            URL.revokeObjectURL(url);
        })
        .catch(err => console.error("Erro ao exportar CSV:", err));
}

    function iniciar() {
        kpiAlertasPorComponente(),
            kpiAlertasTotais(),
            kpiAlertasPorTipo(),
            carregarAlertasRecentes(),
            kpiAlertasCriticos(),
            kpiAlertasSemRegistro()
    }


</script>