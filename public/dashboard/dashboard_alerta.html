<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraFlow - Sistema de Monitoramento</title>
    <link rel="stylesheet" href="../css/dashboard_alerta.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../assets/imgs/estrada.png">
</head>
<script src="../js/alertas.js"></script>

<body onload="iniciar()">

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <aside class="sidebar">

            <nav class="nav">
                <button data-view="overview" class="nav-item">
                    <a href="dashboard.html">
                        <i class="fas fa-gauge"></i>
                        <span>Painel</span>
                    </a>

                </button>
                <button data-view="monitor" class="nav-item">
                    <a href="dashboard.html#monitor">
                        <i class="fas fa-chart-line"></i>
                        <span>Monitoramento</span>
                    </a>

                </button>
                <button data-view="cadastro" class="nav-item">
                    <a href="dashboard.html#cadastro"></a>
                    <i class="fas fa-pen-to-square"></i>
                    <span>Cadastro</span>
                </button>
                <a href="dashboard_alerta.html" class="nav-item active" style="text-decoration: none;">
                    <i class="fas fa-clock-rotate-left"></i>
                    <span>Histórico de Alertas</span>
                </a>
            </nav>

            <div class="divider"></div>

            <div class="user-section">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="sidebarUser">Admin</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Topbar -->
            <header class="topbar">

                <div class="brand">
                    <a href="dashboard.html" title="Voltar para o painel principal">
                        <img src="../assets/infra-parafundobranco.png" alt="InfraFlow">
                    </a>
                </div>
                <div class="topbar-left">
                    <div class="machine-select">
                        <i class="fas fa-server"></i>
                        <label for="edgeSelector"
                            style="display:block; font-size:14px; margin-bottom:4px; color: gray;">
                            Selecione um pórtico FreeFlow:
                        </label>
                        <select id="edgeSelector">
                            <option value="INFRA-EDGE-01-Itápolis (SP-333)">INFRA-EDGE-01-Itápolis (SP-333)</option>
                            <!-- <option value="INFRA-EDGE-02-Jaboticabal (SP-333)">INFRA-EDGE-02-Jaboticabal (SP-333)</option>
              <option value="INFRA-EDGE-03-São José dos Campos (SP-099)">INFRA-EDGE-03-São José dos Campos (SP-099)
              </option>
              <option value="INFRA-EDGE-04-Itaguaí (Km 414)">INFRA-EDGE-04-Itaguaí (Km 414)</option> -->
                        </select>
                    </div>
                    <div class="os-info">
                        <i class="fab fa-ubuntu"></i>
                        <span>Ubuntu 22.04 LTS</span>
                    </div>
                </div>

                <div class="topbar-right">
                    <div class="security-indicator">
                        <a href="seguranca.html" class="nocsec-link" title="NOC/SOC - Centro de Segurança">
                            <i class="fas fa-shield-alt"></i>
                            <span>NOC/SOC</span>
                        </a>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                    <div class="last-update">
                        <span class="update-label">Última atualização:</span>
                        <span class="update-time" id="lastUpdateTime">--:--:--</span>
                    </div>
                </div>



            </header>

            <!-- Visão Geral -->
            <section id="view-overview" class="view active">
                <div class="view-header">
                    <h1 class="view-title">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Visão analítica de alertas <span id="monitor-selecionado"></span>
                    </h1>
                </div>




                <div class="kpis-grid">
                    <div class="kpi-card" id="kpiCpu">
                        <div class="kpi-header">
                            <div class="kpi-icon cpu">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Quantidade de alertas (Geral)</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="total-alertas">
                        </div>


                    </div>

                    <div class="kpi-card" id="kpiDisco">
                        <div class="kpi-header">
                            <div class="kpi-info">
                                <span class="kpi-label">Tipos dos alertas</span>
                            </div>
                        </div>

                        <div class="tipo-alerta atencao" style="background-color: rgb(247, 226, 0);">
                            <div id="qtd_atencao"></div>
                            <div>
                                <p>Atenção</p>
                            </div>
                        </div>
                        <div class="tipo-alerta critico" style="background-color: rgb(152, 0, 0)">
                            <div id="qtd_critico"></div>
                            <div>
                                <p style="color: white;">Critíco</p>
                            </div>
                        </div>


                    </div>

                    <div class="kpi-card" id="kpiDisco">
                        <div class="kpi-header">
                            <div class="kpi-icon disco">
                                <i class="bi bi-alarm-fill"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Atendimentos dentro da SLA</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiDiscoValue">0%</div>


                    </div>

                    <div class="kpi-card" id="kpiRede">
                        <div class="kpi-header">
                            <div class="kpi-icon rede">
                                <i class="bi bi-collection-fill"></i>
                            </div>
                            <div class="kpi-info">
                                <span class="kpi-label">Status de andamento dos alertas</span>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiRedeValue">0 Mbps</div>


                    </div>
                </div>


                <div class="charts-grid">
                    <div class="chart-container full-bleed">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-pulse"></i>
                                Atividade ao Vivo
                            </h3>
                        </div>
                        <div class="chart-content">
                            <div id="heatmap-chart"></div>
                        </div>
                    </div>
                </div>

                <div class="other-things">
                    <div class="componentes-grid">
                        <div class="chart-container-componentes full-bleed">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="bi bi-cpu-fill"></i>
                                    Alertas por componentes
                                </h3>
                            </div>
                            <div class="chart-content-componente">
                                <div id="componentes-chart"></div>
                            </div>
                        </div>
                    </div>



                    <div class="alertas-list-grid">

                        <div class="conteudo ocorrencias-box" id="ocorrenciasBox">

                            <div class="ocorrencias-header">
                                <h3 class="chart-title">
                                    <i class="bi bi-clipboard-data-fill"></i>
                                    Ocorrências
                                </h3>

                                <div class="ocorrencias-actions">
                                    <button class="btn-exportar" id="btnExportarCSV">Exportar CSV</button>
                                </div>
                            </div>

                            <!-- CABEÇALHO DAS COLUNAS — ADICIONADO -->
                            <div class="ocorrencias-head">
                                <div>Pórtico</div>
                                <div>Período</div>
                                <div>Componente</div>
                                <div>Métrica Reg.</div>
                                <div>Tipo</div>
                                <div>Ação/Laudo</div>
                            </div>

                            <div class="list-ocorrencias" id="listaOcorrencias">

                                <!-- <div class="ocorrencia-item critico">
                                    <div class="col">SSP-001</div>
                                    <div class="col">
                                        17/11/2025<br>
                                        <span class="sub">12:29 – 13:29</span>
                                    </div>
                                    <div class="col">CPU</div>
                                    <div class="col">85%</div>
                                    <div class="col tipo">Crítico</div>
                                    <div class="col acao">
                                        <button class="btn-registrar">
                                            Registrar <i class="bi bi-pencil-square"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="ocorrencia-item atencao">
                                    <div class="col">SSP-001</div>
                                    <div class="col">
                                        17/11/2025<br>
                                        <span class="sub">12:29 – 13:29</span>
                                    </div>
                                    <div class="col">RAM</div>
                                    <div class="col">34%</div>
                                    <div class="col tipo">Atenção</div>
                                    <div class="col acao">
                                        <button class="btn-registrar" >
                                            Registrar <i class="bi bi-pencil-square"></i>
                                        </button>
                                    </div>
                                </div> -->

                            </div>

                        </div>

                    </div>

                </div>



                <!-- <div class="alerts-section">
          <h2 class="section-title">
            <i class="fas fa-exclamation-triangle"></i>
            Alertas
          </h2>
          <div class="alerts-grid" id="alertsGrid">
            <!-- Alertas serão inseridos aqui assim que eu conseguir conectar o slack rs -->
                <!-- </div>
        </div> -->
                <!-- Bloco combinado: Status + Legenda lado a lado -->




        </main>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>




</body>

</html>


<script>

    function criarBotaoSuporteJira() {
        const linkBotao = document.createElement('a');
        linkBotao.innerHTML = `
      <img src="../assets/icon/iconeJira.png" alt="Ícone de Suporte" width="24" height="24" />
      Suporte
    `;
        linkBotao.title = "Acessar o Help Desk do Jira";
        linkBotao.href = "https://infraflow-sptech.atlassian.net/servicedesk/customer/portal/2";
        linkBotao.target = "_blank";
        linkBotao.style.cssText = `
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      margin: 0;
      padding: 12px 24px;
      border-radius: 50px;
      border: none;
      text-decoration: none;
      background-color: #0052CC;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      font-weight: 600;
      font-size: 16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
    `;

        linkBotao.onmouseover = function () {
            linkBotao.style.backgroundColor = '#0065FF';
            linkBotao.style.boxShadow = '0 6px 16px rgba(0, 0, 0, 0.3)';
        };
        linkBotao.onmouseout = function () {
            linkBotao.style.backgroundColor = '#0052CC';
            linkBotao.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.25)';
            linkBotao.style.transform = 'scale(1)';
        };

        linkBotao.onmousedown = function () {
            linkBotao.style.transform = 'scale(0.98)';
        };

        linkBotao.onmouseup = function () {
            linkBotao.style.transform = 'scale(1)';
        };

        document.body.appendChild(linkBotao);
    }




    const box = document.getElementById("ocorrenciasBox");
    const btnVerMais = document.getElementById("btnVerMais");
    const btnCSV = document.getElementById("btnExportarCSV");

    btnVerMais.addEventListener("click", () => {
        box.classList.toggle("expandido");

        btnVerMais.textContent =
            box.classList.contains("expandido")
                ? "Ver menos"
                : "Ver mais";
    });


    btnCSV.addEventListener("click", () => {
        const rows = [
            ["Pórtico", "Data", "Horário", "Componente", "Métrica", "Tipo"],
            ["SSP-001", "17/11/2025", "12:29 – 13:29", "CPU", "85%", "Crítico"],
            ["SSP-001", "17/11/2025", "12:29 – 13:29", "RAM", "34%", "Atenção"],
        ];

        let csv = "";
        rows.forEach(r => {
            csv += r.join(";") + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "ocorrencias.csv";
        a.click();
    });

    // tentando funções aquiiiiiii

    function kpiAlertasTotais() {
        fetch('/alertas-route/kpiAlertasTotais', {
            method: "GET"
        }).then(res => res.json())
            .then(function (resultado) {
                console.log("oiiiiii")
                var kpitotal = document.getElementById('total-alertas')
                var alertasTotais = resultado[0].alertasTotais
                kpitotal.innerHTML = `<div class="kpi-value" id="total-alertas"><p>${alertasTotais}</p></div>`

            })
    }

     function kpiAlertasPorTipo() {
    fetch('/alertas-route/kpiAlertasPorTipo', {
        method: "GET"
    }).then(res => res.json())
    
        .then(function (resultado) {
            
        console.log("foi? alertas p tipo")
            if (resultado && resultado.length > 0) {
                
                const alertasAtencao = resultado[0].total_atencao;
                const alertasCriticos = resultado[0].total_critico;
    
                var kpiAtencao = document.getElementById('qtd_atencao');
                if (kpiAtencao) {
                    kpiAtencao.innerHTML = `<div id="qtd_atencao">${alertasAtencao}</div>`;
                }

                
                var kpiCritico = document.getElementById('qtd_critico');
                if (kpiCritico) {
                    kpiCritico.innerHTML = `<div id="qtd_critico" style="color: white;">${alertasCriticos}</div>`;
                }
            

            } else {
                console.warn("Nenhum resultado encontrado.");
            }

        })
        .catch(erro => {
            console.error("ERRO no fetch kpiAlertasPorTipo: ", erro);
        });
}

function carregarAlertasRecentes() {
    fetch("/alertas-route/listarAlertasRecentes")
        .then(res => res.status === 204 ? [] : res.json())
        .then(lista => {
            const div = document.getElementById("listaOcorrencias");
            div.innerHTML = ""; // limpa

            if (!lista || lista.length === 0) {
                div.innerHTML = `<p style="text-align: center">Nenhum alerta encontrado.</p>`;
                return;
            }

            lista.forEach(item => {
                const data = new Date(item.dataHora);

                const classe = item.tipo_alerta == 2 
                    ? "critico"
                    : "atencao";

                const html = `
                    <div class="ocorrencia-item ${classe}">
                        <div class="col">${item.portico}</div>

                        <div class="col">
                            ${data.toLocaleDateString("pt-BR")}<br>
                            <span class="sub">${data.toLocaleTimeString("pt-BR", {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>

                        <div class="col">${item.componente}</div>
                        <div class="col">${item.valor}%</div>

                        <div class="col tipo">
                            ${classe === "critico" ? "Crítico" : "Atenção"}
                        </div>

                        <div class="col acao">
                            <button class="btn-registrar">
                                Registrar <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    </div>
                `;

                div.innerHTML += html;
            });
        })
        .catch(err => console.error("Erro ao carregar alertas:", err));
}


function iniciar() {
    kpiAlertasPorComponente(), 
    kpiAlertasTotais(), 
    kpiAlertasPorTipo(), 
    carregarAlertasRecentes()
}

    
</script>